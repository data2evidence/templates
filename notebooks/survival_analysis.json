{
    "id":"0a135c94-7912-46de-b465-946d89e6a880",
    "name":"Survival Analysis (Kaplan Meier) with CohortMethod",
    "notebookContent":"---\nipynb_metadata:\n  language_info:\n    name: python\njupystar:\n  version: 0.2.1\n---\n# %% [markdown]\n### Survival analysis (Kaplan Meier) study using OHDSI Strategus framework\n# %% [markdown]\n##### Research Question - What is the time to first gastrointestinal (GI) bleeding event among patients with exposure to celecoxib / diclofenac?\n# %% [markdown]\n##### Step 1 - Import the necessary libraries\n\n# %% [jupyter]\n# import libraries\nlibrary(rD2E)\nlibrary(Strategus)\nlibrary(dplyr)\n# %% [markdown]\n##### Step 2 - Load pre-defined cohorts definitions using rD2E library\n# %% [jupyter]\ntarCohortId <- 61\noutCohortId <- 63\ncompCohortId <- 62 # replace these with the actual cohort ID\ncohorts_set <- c(tarCohortId, compCohortId, outCohortId)\ncohortDefinitionSet <- rD2E::get_cohort_definition_set(cohorts_set)\n# %% [markdown]\n##### Step 3 - Define the network study components\n# %% [jupyter]\npriorOutcomeLookback <- 30\nstudyStartDate <- \"20071201\"\nstudyEndDate <- \"20080331\"\n\n# Target-Comparator pairs\ncmTcList <- data.frame(\n  targetCohortId = tarCohortId,\n  targetCohortName = \"Celecoxib Users\",\n  comparatorCohortId = compCohortId,\n  comparatorCohortName = \"Diclofenac Users\"\n)\n\n# Outcome cohort\noutcomeCohortId <- outCohortId\n\n# Set time-at-risk\ntimeAtRisks <- tibble(\n  label = c(\"Survival Analysis Kaplan Meier\"),\n  riskWindowStart  = c(1),\n  startAnchor = c(\"cohort start\"),\n  riskWindowEnd  = c(90),\n  endAnchor = c(\"cohort end\")\n)\n\n# Define the outcome\noutcomeList <- lapply(seq_len(1), function(i) {\n  CohortMethod::createOutcome(\n    outcomeId = outcomeCohortId,\n    outcomeOfInterest = TRUE,\n    # trueEffectSize = NA,\n    priorOutcomeLookback = priorOutcomeLookback\n  )\n})\n\n# Define the T-C-O structure\ntargetComparatorOutcomesList <- list(\n  CohortMethod::createTargetComparatorOutcomes(\n    targetId = cmTcList$targetCohortId,\n    comparatorId = cmTcList$comparatorCohortId,\n    outcomes = outcomeList\n  )\n)\n# %% [markdown]\nCreate settings for modules involved in the study\n# %% [jupyter]\n# Setup cohort method module\ncmModuleSettingsCreator <- CohortMethodModule$new()\n\ncmAnalysisList <- list(\n  CohortMethod::createCmAnalysis(\n    analysisId = 1,\n    description = \"Kaplan Meier analysis with PS matching\",\n    getDbCohortMethodDataArgs = CohortMethod::createGetDbCohortMethodDataArgs(\n      restrictToCommonPeriod = FALSE,\n      studyStartDate = studyStartDate,\n      studyEndDate = studyEndDate,\n      covariateSettings = FeatureExtraction::createDefaultCovariateSettings(\n  \t\texcludedCovariateConceptIds = c(\n          1124300,  # Diclofenac\n          1118084   # Celecoxib\n      \t),\n  \t\taddDescendantsToExclude = TRUE\n      )\n    ),\n    createStudyPopArgs = CohortMethod::createCreateStudyPopulationArgs(\n        firstExposureOnly = FALSE,\n        removeSubjectsWithPriorOutcome = TRUE,\n        priorOutcomeLookback = priorOutcomeLookback,\n        riskWindowStart = timeAtRisks$riskWindowStart,\n        startAnchor = timeAtRisks$startAnchor,\n        riskWindowEnd = timeAtRisks$riskWindowEnd,\n        endAnchor = timeAtRisks$endAnchor,\n        minDaysAtRisk = 1,\n    ),\n  \tcreatePsArgs = CohortMethod::createCreatePsArgs(\n      maxCohortSizeForFitting = 250000,\n      errorOnHighCorrelation = TRUE,\n      prior = Cyclops::createPrior(\n        priorType = \"laplace\", \n        useCrossValidation = TRUE\n      ),\n    ),\n    matchOnPsArgs = CohortMethod::createMatchOnPsArgs(\n      maxRatio = 100,\n    ),\n    computeSharedCovariateBalanceArgs = CohortMethod::createComputeCovariateBalanceArgs(),\n    computeCovariateBalanceArgs = CohortMethod::createComputeCovariateBalanceArgs(),\n    fitOutcomeModelArgs = CohortMethod::createFitOutcomeModelArgs(\n      modelType = \"cox\",\n      useCovariates = TRUE,\n      stratified = TRUE\n    )\n  )\n)\n\ncohortMethodModuleSpecifications <- cmModuleSettingsCreator$createModuleSpecifications(\n  cmAnalysisList = cmAnalysisList,\n  targetComparatorOutcomesList = targetComparatorOutcomesList,\n  refitPsForEveryOutcome = FALSE,\n  refitPsForEveryStudyPopulation = FALSE,  \n  cmDiagnosticThresholds = CohortMethod::createCmDiagnosticThresholds()\n)\n\n# Cohort Generator Module\ncgModuleSettingsCreator <- CohortGeneratorModule$new()\ncohortDefinitionShared <- cgModuleSettingsCreator$createCohortSharedResourceSpecifications(cohortDefinitionSet)\ncohortGeneratorModuleSpecifications <- cgModuleSettingsCreator$createModuleSpecifications()\n# %% [markdown]\nCreate the analysis specification object - including all the modules and configurations created above\n# %% [jupyter]\n# Final Analysis Spec\nanalysisSpecifications <- createEmptyAnalysisSpecificiations() |>\n  addSharedResources(cohortDefinitionShared) |>\n  addModuleSpecifications(cohortGeneratorModuleSpecifications) |>\n  addModuleSpecifications(cohortMethodModuleSpecifications)\n# %% [markdown]\n##### Step 4 - Execute the Strategus study\n# %% [jupyter]\nstudy_name <- \"survival_analysis_kaplan_meier\"  # Unique study name\noptions <- create_options(upload_results=TRUE, study_id = study_name) # set a study_id with a unique id\nrD2E::run_strategus_flow(analysisSpecification = analysisSpecifications, options = options)",
    "isShared":true,
    "datasetId":"a45d3365-cf3c-43f6-820a-c13c2bba9bac"
}