{   "name": "Fhir Anonymizer Template",
    "description": "Anonymize FHIR data using Microsoft FHIR Anonymizer tool",
    "edges": [
      {
        "id": "reactflow__edge-fde165da-0723-43c8-8dff-963c49181a76source_fde165da-0723-43c8-8dff-963c49181a76_object-1a256c27-e86e-41d5-bd6d-338f2fe2ee7atarget_1a256c27-e86e-41d5-bd6d-338f2fe2ee7a_any",
        "source": "fde165da-0723-43c8-8dff-963c49181a76",
        "target": "1a256c27-e86e-41d5-bd6d-338f2fe2ee7a",
        "sourceHandle": "source_fde165da-0723-43c8-8dff-963c49181a76_object",
        "targetHandle": "target_1a256c27-e86e-41d5-bd6d-338f2fe2ee7a_any"
      },
      {
        "id": "reactflow__edge-053a77a5-d4c0-4c77-b040-7a53fb2b5037source_053a77a5-d4c0-4c77-b040-7a53fb2b5037_object-fde165da-0723-43c8-8dff-963c49181a76target_fde165da-0723-43c8-8dff-963c49181a76_any",
        "source": "053a77a5-d4c0-4c77-b040-7a53fb2b5037",
        "target": "fde165da-0723-43c8-8dff-963c49181a76",
        "selected": false,
        "sourceHandle": "source_053a77a5-d4c0-4c77-b040-7a53fb2b5037_object",
        "targetHandle": "target_fde165da-0723-43c8-8dff-963c49181a76_any"
      },
      {
        "id": "reactflow__edge-c5f4cf18-a331-4384-8f0e-8f602705ce84source_c5f4cf18-a331-4384-8f0e-8f602705ce84_any-2829b691-ca0d-426d-92f1-80278d0d5957target_2829b691-ca0d-426d-92f1-80278d0d5957_any",
        "source": "c5f4cf18-a331-4384-8f0e-8f602705ce84",
        "target": "2829b691-ca0d-426d-92f1-80278d0d5957",
        "sourceHandle": "source_c5f4cf18-a331-4384-8f0e-8f602705ce84_any",
        "targetHandle": "target_2829b691-ca0d-426d-92f1-80278d0d5957_any"
      },
      {
        "id": "reactflow__edge-a1c23953-e541-4487-9825-2825f8204cc1source_a1c23953-e541-4487-9825-2825f8204cc1_any-ced70aef-4591-4987-9887-99547808ceb1target_ced70aef-4591-4987-9887-99547808ceb1_any",
        "source": "a1c23953-e541-4487-9825-2825f8204cc1",
        "target": "ced70aef-4591-4987-9887-99547808ceb1",
        "sourceHandle": "source_a1c23953-e541-4487-9825-2825f8204cc1_any",
        "targetHandle": "target_ced70aef-4591-4987-9887-99547808ceb1_any"
      },
      {
        "id": "reactflow__edge-2829b691-ca0d-426d-92f1-80278d0d5957source_2829b691-ca0d-426d-92f1-80278d0d5957_object-fde165da-0723-43c8-8dff-963c49181a76target_fde165da-0723-43c8-8dff-963c49181a76_any",
        "source": "2829b691-ca0d-426d-92f1-80278d0d5957",
        "target": "fde165da-0723-43c8-8dff-963c49181a76",
        "sourceHandle": "source_2829b691-ca0d-426d-92f1-80278d0d5957_object",
        "targetHandle": "target_fde165da-0723-43c8-8dff-963c49181a76_any"
      },
      {
        "id": "reactflow__edge-ced70aef-4591-4987-9887-99547808ceb1source_ced70aef-4591-4987-9887-99547808ceb1_object-fde165da-0723-43c8-8dff-963c49181a76target_fde165da-0723-43c8-8dff-963c49181a76_any",
        "source": "ced70aef-4591-4987-9887-99547808ceb1",
        "target": "fde165da-0723-43c8-8dff-963c49181a76",
        "sourceHandle": "source_ced70aef-4591-4987-9887-99547808ceb1_object",
        "targetHandle": "target_fde165da-0723-43c8-8dff-963c49181a76_any"
      }],
    "nodes": [
      {
        "id": "fde165da-0723-43c8-8dff-963c49181a76",
        "data": {
          "name": "SetConstants",
          "description": "Set constants for the flow",
          "python_code": "def exec(myinput):\n  config_file = myinput[\"config_file_processor\"].result\n  INPUT_DIR = myinput[\"data_file_processor\"].result\n  ANONYMIZER = myinput[\"R4 Fhir Anonymizer - Mac\"].result # please replace this with the tool of your OS\n  output_dir = input_dir.parent / \"fhir_output\"\n  output_dir.mkdir(exist_ok=True)\n  return {\n    \"ANONYMIZER\" : ANONYMIZER,\n    \"CONFIG_FILE\" : config_file,\n    \"INPUT_DIR\" : str(INPUT_DIR),\n    \"OUTPUT_DIR\" : str(output_dir)\n  }"
        },
        "type": "python_node",
        "width": 350,
        "height": 210,
        "dragging": false,
        "position": {
          "x": -1430,
          "y": 100
        },
        "selected": false,
        "dragHandle": "",
        "sourcePosition": "right",
        "targetPosition": "left",
        "positionAbsolute": {
          "x": -1430,
          "y": 100
        }
      },
      {
        "id": "1a256c27-e86e-41d5-bd6d-338f2fe2ee7a",
        "data": {
          "name": "anonymizer",
          "description": "Describe the task of node python_node_2",
          "python_code": "import subprocess\n\ndef exec(myinput) -> str:\n    input_dir = myinput[\"SetConstants\"].result.get(\"INPUT_DIR\")\n    ANONYMIZER = myinput[\"SetConstants\"].result.get(\"ANONYMIZER\")\n    output_dir = myinput[\"SetConstants\"].result.get(\"OUTPUT_DIR\")\n\n    config_dir = Path(myinput[\"SetConstants\"].result.get(\"CONFIG_FILE\"))\n    # Get the first (and presumably only) file inside the folder\n    config_file = next(config_dir.glob(\"*\"))\n    print(f\"Take input from {input_dir} anonymize with {ANONYMIZER}, with config at {config_file}, output to {output_dir}\")\n    # Run the anonymizer tool\n    cmd = [\n        \"dotnet\", ANONYMIZER,\n        \"-i\", input_dir,\n        \"-o\", output_dir,\n        \"-b\", input_dir,\n        \"-c\", str(config_file)\n    ]\n    subprocess.run(cmd, check=True)\n    return output_dir\n    "
        },
        "type": "python_node",
        "width": 350,
        "height": 210,
        "dragging": false,
        "position": {
          "x": -750,
          "y": 100
        },
        "selected": false,
        "dragHandle": "",
        "sourcePosition": "right",
        "targetPosition": "left",
        "positionAbsolute": {
          "x": -750,
          "y": 100
        }
      },
      {
        "id": "a1c23953-e541-4487-9825-2825f8204cc1",
        "data": {
          "name": "JsonConfiguration",
          "description": "Describe the task of node file_node_1"
        },
        "type": "file_node",
        "width": 350,
        "height": 210,
        "dragging": false,
        "position": {
          "x": -2900,
          "y": 270
        },
        "selected": false,
        "dragHandle": "",
        "sourcePosition": "right",
        "targetPosition": "left",
        "positionAbsolute": {
          "x": -2900,
          "y": 270
        }
      },
      {
        "id": "053a77a5-d4c0-4c77-b040-7a53fb2b5037",
        "data": {
          "name": "R4 Fhir Anonymizer - Mac",
          "description": "Describe the task of node python_node_2",
          "python_code": "from io import BytesIO\n\ndef exec(myinput):\n  \"\"\"\n    Downloads and extracts the latest Microsoft FHIR Anonymizer CommandLineTool.zip\n    into /app/flows/data_transformation/fhir-anonymizer, returning the DLL path.\n  \"\"\"\n  TARGET_DIR = Path(\"/app/downloads/fhir-anonymizer\")\n  TARGET_DIR.mkdir(parents=True, exist_ok=True)\n\n  print(\"Fetching latest FHIR Anonymizer release info...\")\n  #always get the latest version of fhir anonymizer\n  release_api = \"https://api.github.com/repos/microsoft/Tools-for-Health-Data-Anonymization/releases/latest\"\n  response = requests.get(release_api)\n  response.raise_for_status()\n  release_data = response.json()\n\n  # Find the R4 CommandLineTool asset\n  assets = release_data.get(\"assets\", [])\n  asset = next(\n    (a for a in assets if a[\"name\"] == \"Microsoft.Health.Fhir.Anonymizer.R4.CommandLineTool.zip\"),\n    None\n  )\n\n  if not asset:\n    raise RuntimeError(\"Could not find Microsoft.Health.Fhir.Anonymizer.R4.CommandLineTool.zip in latest release\")\n\n  asset_url = asset[\"url\"]\n  print(f\"Downloading asset from GitHub API asset URL: {asset_url}\")\n\n  # The asset API URL requires this header to get the binary content\n  headers = {\"Accept\": \"application/octet-stream\"}\n  download = requests.get(asset_url, headers=headers, stream=True)\n  download.raise_for_status()\n\n  # Extract directly from memory\n  with zipfile.ZipFile(BytesIO(download.content)) as zip_ref:\n    zip_ref.extractall(TARGET_DIR)\n\n  dll_path = TARGET_DIR / \"Microsoft.Health.Fhir.Anonymizer.R4.CommandLineTool.dll\"\n  print(f\"Extracted FHIR Anonymizer to {TARGET_DIR}\")\n  return str(dll_path)\n"
        },
        "type": "python_node",
        "width": 350,
        "height": 210,
        "dragging": false,
        "position": {
          "x": -2320,
          "y": 650
        },
        "selected": false,
        "dragHandle": "",
        "sourcePosition": "right",
        "targetPosition": "left",
        "positionAbsolute": {
          "x": -2320,
          "y": 650
        }
      },
      {
        "id": "b74c1f79-18ea-402a-9d94-c5e6e2a427d3",
        "data": {
          "name": "R4 Fhir Anonymizer - Windows",
          "description": "Describe the task of node python_node_3",
          "python_code": "from io import BytesIO\n\ndef exec(myinput):\n  \"\"\"\n    Downloads and extracts the latest Microsoft FHIR Anonymizer CommandLineTool.zip\n    into /app/flows/data_transformation/fhir-anonymizer, returning the DLL path.\n  \"\"\"\n  TARGET_DIR = Path(\"/app/downloads/fhir-anonymizer\")\n  TARGET_DIR.mkdir(parents=True, exist_ok=True)\n\n  print(\"Fetching latest FHIR Anonymizer release info...\")\n  #always get the latest version of fhir anonymizer\n  release_api = \"https://api.github.com/repos/microsoft/Tools-for-Health-Data-Anonymization/releases/latest\"\n  response = requests.get(release_api)\n  response.raise_for_status()\n  release_data = response.json()\n\n  # Find the R4 CommandLineTool asset\n  assets = release_data.get(\"assets\", [])\n  asset = next(\n    (a for a in assets if a[\"name\"] == \"Microsoft.Health.Fhir.Anonymizer.R4.CommandLineTool.zip\"),\n    None\n  )\n\n  if not asset:\n    raise RuntimeError(\"Could not find Microsoft.Health.Fhir.Anonymizer.R4.CommandLineTool.zip in latest release\")\n\n  asset_url = asset[\"url\"]\n  print(f\"Downloading asset from GitHub API asset URL: {asset_url}\")\n\n  # The asset API URL requires this header to get the binary content\n  headers = {\"Accept\": \"application/octet-stream\"}\n  download = requests.get(asset_url, headers=headers, stream=True)\n  download.raise_for_status()\n\n  # Extract directly from memory\n  with zipfile.ZipFile(BytesIO(download.content)) as zip_ref:\n    zip_ref.extractall(TARGET_DIR)\n\n  dll_path = TARGET_DIR / \"Microsoft.Health.Fhir.Anonymizer.R4.CommandLineTool.exe\"\n  print(f\"Extracted FHIR Anonymizer to {TARGET_DIR}\")\n  return str(dll_path)\n"
        },
        "type": "python_node",
        "width": 350,
        "height": 210,
        "dragging": false,
        "position": {
          "x": -2310,
          "y": 970
        },
        "selected": false,
        "dragHandle": "",
        "sourcePosition": "right",
        "targetPosition": "left",
        "positionAbsolute": {
          "x": -2310,
          "y": 970
        }
      },
      {
        "id": "5bcc2df2-c109-4d43-8215-8c00b2bdff22",
        "data": {
          "name": "Stu3 Fhir Anonymizer - Mac",
          "description": "Describe the task of node python_node_4",
          "python_code": "from io import BytesIO\n\ndef exec(myinput):\n  \"\"\"\n    Downloads and extracts the latest Microsoft FHIR Anonymizer CommandLineTool.zip\n    into /app/flows/data_transformation/fhir-anonymizer, returning the DLL path.\n  \"\"\"\n  TARGET_DIR = Path(\"/app/downloads/fhir-anonymizer\")\n  TARGET_DIR.mkdir(parents=True, exist_ok=True)\n\n  print(\"Fetching latest FHIR Anonymizer release info...\")\n  #always get the latest version of fhir anonymizer\n  release_api = \"https://api.github.com/repos/microsoft/Tools-for-Health-Data-Anonymization/releases/latest\"\n  response = requests.get(release_api)\n  response.raise_for_status()\n  release_data = response.json()\n\n  # Find the R4 CommandLineTool asset\n  assets = release_data.get(\"assets\", [])\n  asset = next(\n    (a for a in assets if a[\"name\"] == \"Microsoft.Health.Fhir.Anonymizer.Stu3.CommandLineTool.zip\"),\n    None\n  )\n\n  if not asset:\n    raise RuntimeError(\"Could not find Microsoft.Health.Fhir.Anonymizer.Stu3.CommandLineTool.zip in latest release\")\n\n  asset_url = asset[\"url\"]\n  print(f\"Downloading asset from GitHub API asset URL: {asset_url}\")\n\n  # The asset API URL requires this header to get the binary content\n  headers = {\"Accept\": \"application/octet-stream\"}\n  download = requests.get(asset_url, headers=headers, stream=True)\n  download.raise_for_status()\n\n  # Extract directly from memory\n  with zipfile.ZipFile(BytesIO(download.content)) as zip_ref:\n    zip_ref.extractall(TARGET_DIR)\n\n  dll_path = TARGET_DIR / \"Microsoft.Health.Fhir.Anonymizer.Stu3.CommandLineTool.dll\"\n  print(f\"Extracted FHIR Anonymizer to {TARGET_DIR}\")\n  return str(dll_path)\n"
        },
        "type": "python_node",
        "width": 350,
        "height": 210,
        "dragging": false,
        "position": {
          "x": -1700,
          "y": 650
        },
        "selected": false,
        "dragHandle": "",
        "sourcePosition": "right",
        "targetPosition": "left",
        "positionAbsolute": {
          "x": -1700,
          "y": 650
        }
      },
      {
        "id": "06d68a83-c85b-48cf-a599-e0126d7b9aab",
        "data": {
          "name": "Stu3 Fhir Anonymizer - Windows",
          "description": "Describe the task of node python_node_5",
          "python_code": "from io import BytesIO\n\ndef exec(myinput):\n  \"\"\"\n    Downloads and extracts the latest Microsoft FHIR Anonymizer CommandLineTool.zip\n    into /app/flows/data_transformation/fhir-anonymizer, returning the DLL path.\n  \"\"\"\n  TARGET_DIR = Path(\"/app/downloads/fhir-anonymizer\")\n  TARGET_DIR.mkdir(parents=True, exist_ok=True)\n\n  print(\"Fetching latest FHIR Anonymizer release info...\")\n  #always get the latest version of fhir anonymizer\n  release_api = \"https://api.github.com/repos/microsoft/Tools-for-Health-Data-Anonymization/releases/latest\"\n  response = requests.get(release_api)\n  response.raise_for_status()\n  release_data = response.json()\n\n  # Find the R4 CommandLineTool asset\n  assets = release_data.get(\"assets\", [])\n  asset = next(\n    (a for a in assets if a[\"name\"] == \"Microsoft.Health.Fhir.Anonymizer.Stu3.CommandLineTool.zip\"),\n    None\n  )\n\n  if not asset:\n    raise RuntimeError(\"Could not find Microsoft.Health.Fhir.Anonymizer.Stu3.CommandLineTool.zip in latest release\")\n\n  asset_url = asset[\"url\"]\n  print(f\"Downloading asset from GitHub API asset URL: {asset_url}\")\n\n  # The asset API URL requires this header to get the binary content\n  headers = {\"Accept\": \"application/octet-stream\"}\n  download = requests.get(asset_url, headers=headers, stream=True)\n  download.raise_for_status()\n\n  # Extract directly from memory\n  with zipfile.ZipFile(BytesIO(download.content)) as zip_ref:\n    zip_ref.extractall(TARGET_DIR)\n\n  dll_path = TARGET_DIR / \"Microsoft.Health.Fhir.Anonymizer.Stu3.CommandLineTool.exe\"\n  print(f\"Extracted FHIR Anonymizer to {TARGET_DIR}\")\n  return str(dll_path)\n\n  "
        },
        "type": "python_node",
        "width": 354,
        "height": 214,
        "dragging": false,
        "position": {
          "x": -1700,
          "y": 970
        },
        "selected": false,
        "dragHandle": "",
        "sourcePosition": "right",
        "targetPosition": "left",
        "positionAbsolute": {
          "x": -1700,
          "y": 970
        }
      },
      {
        "id": "c5f4cf18-a331-4384-8f0e-8f602705ce84",
        "data": {
          "name": "data_file",
          "description": "The node should take a R4/Stu3 ndjson file"
        },
        "type": "file_node",
        "width": 350,
        "height": 210,
        "dragging": false,
        "position": {
          "x": -2910,
          "y": -160
        },
        "selected": false,
        "dragHandle": "",
        "sourcePosition": "right",
        "targetPosition": "left",
        "positionAbsolute": {
          "x": -2910,
          "y": -160
        }
      },
      {
        "id": "2829b691-ca0d-426d-92f1-80278d0d5957",
        "data": {
          "name": "data_file_processor",
          "description": "Describe the task of node python_node_6",
          "python_code": "from _shared_flow_utils.api.SupabaseStorageAPI import SupabaseStorageAPI\n\ndef exec(myinput):\n  node_id = myinput[\"data_file\"].result.get(\"node_id\")\n  filename = myinput[\"data_file\"].result.get(\"filename\")\n  raw_data = SupabaseStorageAPI().get_file(node_id, filename)\n  output_folder = Path(\"./downloads/data_file\")\n\n  output_folder.mkdir(exist_ok=True)\n  save_path = output_folder / filename\n  save_path.write_bytes(raw_data)\n  return save_path"
        },
        "type": "python_node",
        "width": 354,
        "height": 214,
        "dragging": false,
        "position": {
          "x": -2330,
          "y": -160
        },
        "selected": false,
        "dragHandle": "",
        "sourcePosition": "right",
        "targetPosition": "left",
        "positionAbsolute": {
          "x": -2330,
          "y": -160
        }
      },
      {
        "id": "ced70aef-4591-4987-9887-99547808ceb1",
        "data": {
          "name": "config_file_processor",
          "description": "Describe the task of node python_node_7",
          "python_code": "from _shared_flow_utils.api.SupabaseStorageAPI import SupabaseStorageAPI\n\ndef exec(myinput):\n  node_id = myinput[\"JsonConfiguration\"].result.get(\"node_id\")\n  filename = myinput[\"JsonConfiguration\"].result.get(\"filename\")\n  raw_data = SupabaseStorageAPI().get_file(node_id, filename)\n  output_folder = Path(\"./downloads/config_file\")\n\n  output_folder.mkdir(exist_ok=True)\n  save_path = output_folder / filename\n  save_path.write_bytes(raw_data)\n  return save_path"
        },
        "type": "python_node",
        "width": 354,
        "height": 214,
        "dragging": false,
        "position": {
          "x": -2330,
          "y": 270
        },
        "selected": false,
        "dragHandle": "",
        "sourcePosition": "right",
        "targetPosition": "left",
        "positionAbsolute": {
          "x": -2330,
          "y": 270
        }
      },
      {
        "id": "799c1f43-031e-496e-8c2d-781eebf8a018",
        "data": {
          "name": "README",
          "description": "Describe the task of node python_node_8",
          "python_code": "def exec(myinput):\n  \"\"\" This tool requires a user defined configuration file so that the user\n      can choose to hide certain fields of the dataset.\n      One such configuration is provided here, copy and paste the contents \n      below into a .json file and upload it to the JsonConfiguration\n      node to test the tool.\n      For a more specific anonymization behavior, such as date and value perturbation,\n      please refer to the website: \n      https://github.com/microsoft/Tools-for-Health-Data-Anonymization/blob/master/README.md\n  \"\"\"\n  return  {\n            \"fhirVersion\": \"R4\",\n            \"processingError\":\"raise\",\n            \"fhirPathRules\": [\n              {\"path\": \"nodesByType('Extension')\", \"method\": \"redact\"},\n              {\"path\": \"Organization.identifier\", \"method\": \"keep\"},\n              {\"path\": \"nodesByType('Address').country\", \"method\": \"keep\"},\n              {\"path\": \"Resource.id\", \"method\": \"cryptoHash\"},\n              {\"path\": \"nodesByType('Reference').reference\", \"method\": \"cryptoHash\"},\n              {\"path\": \"Group.name\", \"method\": \"redact\"},\n              {\"path\": \"nodesByType('identifier').value\", \"method\": \"cryptoHash\"},\n              {\n                  \"path\": \"Observation.valueQuantity.value\",\n                  \"method\": \"perturb\",\n                  \"span\": 0.2,\n                  \"rangeType\": \"proportional\",\n                  \"roundTo\": 0\n              },\n              { \"path\": \"nodesByType('date')\", \"method\": \"dateShift\" }\n            ],\n            \"parameters\": {\n              \"dateShiftKey\": \"\",\n              \"cryptoHashKey\": \"\",\n              \"encryptKey\": \"\",\n              \"enablePartialAgesForRedact\": true\n            }\n          }"
        },
        "type": "python_node",
        "width": 354,
        "height": 214,
        "dragging": false,
        "position": {
          "x": -3490,
          "y": 20
        },
        "selected": true,
        "dragHandle": "",
        "sourcePosition": "right",
        "targetPosition": "left",
        "positionAbsolute": {
          "x": -3490,
          "y": 20
        }
      }
    ],
    "variables": [],
    "importLibs": [
      "import requests",
      "import json",
      "import os",
      "from pathlib import Path",
      "from time import sleep",
      "import zipfile"
    ]
  }
