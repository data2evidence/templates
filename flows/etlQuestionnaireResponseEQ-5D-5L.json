{
    "id": "8da69c47-acc9-44b6-b4e3-2c6b131dfd07",
    "name": "Transform QuestionnaireResponse EQ-5D-5L to OMOP Measurement",
    "edges": [
        {
            "id": "reactflow__edge-a761976d-1b68-4fff-9d09-32d4fbb64f2dsource_a761976d-1b68-4fff-9d09-32d4fbb64f2d_dataframe-0ef53c18-cf39-400e-8237-dbc805cda74dtarget_0ef53c18-cf39-400e-8237-dbc805cda74d_dataframe",
            "source": "a761976d-1b68-4fff-9d09-32d4fbb64f2d",
            "target": "0ef53c18-cf39-400e-8237-dbc805cda74d",
            "sourceHandle": "source_a761976d-1b68-4fff-9d09-32d4fbb64f2d_dataframe",
            "targetHandle": "target_0ef53c18-cf39-400e-8237-dbc805cda74d_dataframe"
        },
        {
            "id": "reactflow__edge-832800a3-c03f-44e0-8a99-9de1a5a3e080source_832800a3-c03f-44e0-8a99-9de1a5a3e080_dataframe-cacfa438-5766-4a57-bad2-71b3801bc1b8target_cacfa438-5766-4a57-bad2-71b3801bc1b8_dataframe",
            "source": "832800a3-c03f-44e0-8a99-9de1a5a3e080",
            "target": "cacfa438-5766-4a57-bad2-71b3801bc1b8",
            "sourceHandle": "source_832800a3-c03f-44e0-8a99-9de1a5a3e080_dataframe",
            "targetHandle": "target_cacfa438-5766-4a57-bad2-71b3801bc1b8_dataframe"
        },
        {
            "id": "reactflow__edge-0ef53c18-cf39-400e-8237-dbc805cda74dsource_0ef53c18-cf39-400e-8237-dbc805cda74d_dataframe-4a0790fd-2758-470a-8fda-f3e8fdae71f3target_4a0790fd-2758-470a-8fda-f3e8fdae71f3_any",
            "source": "0ef53c18-cf39-400e-8237-dbc805cda74d",
            "target": "4a0790fd-2758-470a-8fda-f3e8fdae71f3",
            "sourceHandle": "source_0ef53c18-cf39-400e-8237-dbc805cda74d_dataframe",
            "targetHandle": "target_4a0790fd-2758-470a-8fda-f3e8fdae71f3_any"
        },
        {
            "id": "reactflow__edge-4a0790fd-2758-470a-8fda-f3e8fdae71f3source_4a0790fd-2758-470a-8fda-f3e8fdae71f3_object-832800a3-c03f-44e0-8a99-9de1a5a3e080target_832800a3-c03f-44e0-8a99-9de1a5a3e080_object",
            "source": "4a0790fd-2758-470a-8fda-f3e8fdae71f3",
            "target": "832800a3-c03f-44e0-8a99-9de1a5a3e080",
            "sourceHandle": "source_4a0790fd-2758-470a-8fda-f3e8fdae71f3_object",
            "targetHandle": "target_832800a3-c03f-44e0-8a99-9de1a5a3e080_object"
        }
    ],
    "nodes": [
        {
            "id": "a761976d-1b68-4fff-9d09-32d4fbb64f2d",
            "data": {
                "name": "get_fhir_data",
                "error": false,
                "database": "d2e_fhir",
                "sqlquery": "select qr.content\nfrom \nfhir.\"QuestionnaireResponse\" qr \njoin fhir.\"Project\" p \non qr.\"projectId\" = p.\"projectId\" \nwhere p.\"name\" = '2a05eaa3-9c7b-4705-b1c8-905eb1d246a7'",
                "testdata": [
                    []
                ],
                "description": "Get QuestionnaireResponse fhir data from database",
                "errorMessage": null
            },
            "type": "db_reader_node",
            "width": 350,
            "height": 210,
            "dragging": false,
            "position": {
                "x": -940,
                "y": -90
            },
            "selected": false,
            "dragHandle": "",
            "sourcePosition": "right",
            "targetPosition": "left",
            "positionAbsolute": {
                "x": -940,
                "y": -90
            }
        },
        {
            "id": "0ef53c18-cf39-400e-8237-dbc805cda74d",
            "data": {
                "id": "EQ-5D-5LMap",
                "name": "transform_fhir_to_omop",
                "error": false,
                "dataframe": "get_fhir_data",
                "description": "Transforms fhir data to omop measurement using structure map",
                "errorMessage": null,
                "structure_map": "{\n  \"resourceType\": \"StructureMap\",\n  \"id\": \"EQ5D5L-to-OMOP-Measurement\",\n  \"url\": \"http://example.org/StructureMap/EQ5D5L-to-OMOP-Measurement\",\n  \"version\": \"1.0.0\",\n  \"name\": \"EQ5D5L_to_OMOP_Measurement\",\n  \"status\": \"active\",\n  \"date\": \"2025-11-13\",\n  \"publisher\": \"Example Health Analytics\",\n  \"structure\": [\n    {\n      \"url\": \"http://hl7.org/fhir/StructureDefinition/QuestionnaireResponse\",\n      \"mode\": \"source\"\n    },\n    {\n      \"url\": \"http://hl7.org/fhir/uv/omop/StructureDefinition/Measurement\",\n      \"mode\": \"target\"\n    }\n  ],\n  \"group\": [\n    {\n      \"name\": \"EQ5D5L_to_Measurement\",\n      \"typeMode\": \"none\",\n      \"input\": [\n        {\n          \"name\": \"src\",\n          \"type\": \"QuestionnaireResponse\",\n          \"mode\": \"source\"\n        },\n        {\n          \"name\": \"tgt\",\n          \"type\": \"Measurement\",\n          \"mode\": \"target\"\n        }\n      ],\n      \"rule\": [\n        {\n          \"name\": \"mapEachItem\",\n          \"source\": [\n            {\n              \"context\": \"src\",\n              \"element\": \"item\",\n              \"variable\": \"qitem\"\n            }\n          ],\n          \"rule\": [\n            {\n              \"name\": \"createMeasurement\",\n              \"source\": [\n                {\n                  \"context\": \"qitem\",\n                  \"variable\": \"qitem\"\n                },\n                {\n                  \"context\": \"src\",\n                  \"variable\": \"src\"\n                }\n              ],\n              \"target\": [\n                {\n                  \"context\": \"tgt\",\n                  \"transform\": \"create\",\n                  \"parameter\": [\n                    {\n                      \"value\": \"Measurement\"\n                    }\n                  ]\n                }\n              ],\n              \"rule\": [\n                {\n                  \"name\": \"mapMeasurementId\",\n                  \"documentation\": \"Generate a unique OMOP measurement_id.\",\n                  \"source\": [\n                    {\n                      \"context\": \"src\",\n                      \"element\": \"id\",\n                      \"variable\": \"measurement_id\"\n                    }\n                  ],\n                  \"target\": [\n                    {\n                      \"context\": \"tgt\",\n                      \"element\": \"measurement_id\",\n                      \"transform\": \"copy\",\n                      \"parameter\": [\n                        {\n                          \"valueId\": \"measurement_id\"\n                        }\n                      ]\n                    }\n                  ]\n                },\n                {\n                  \"name\": \"mapPatientId\",\n                  \"source\": [\n                    {\n                      \"context\": \"src\",\n                      \"element\": \"subject\",\n                      \"variable\": \"patRef\"\n                    }\n                  ],\n                  \"target\": [\n                    {\n                      \"context\": \"tgt\",\n                      \"element\": \"person_id\",\n                      \"transform\": \"copy\",\n                      \"parameter\": [\n                        {\n                          \"valueId\": \"patRef\"\n                        }\n                      ]\n                    }\n                  ]\n                },\n                {\n                  \"name\": \"measurement_datetime\",\n                  \"source\": [\n                    {\n                      \"context\": \"src\",\n                      \"element\": \"authored\",\n                      \"variable\": \"measurement_datetime\"\n                    }\n                  ],\n                  \"target\": [\n                    {\n                      \"context\": \"tgt\",\n                      \"element\": \"measurement_datetime\",\n                      \"transform\": \"copy\",\n                      \"parameter\": [\n                        {\n                          \"valueId\": \"measurement_datetime\"\n                        }\n                      ]\n                    }\n                  ]\n                },\n                {\n                  \"name\": \"measurement_date\",\n                  \"source\": [\n                    {\n                      \"context\": \"src\",\n                      \"element\": \"authored\",\n                      \"variable\": \"measurement_date\"\n                    }\n                  ],\n                  \"target\": [\n                    {\n                      \"context\": \"tgt\",\n                      \"element\": \"measurement_date\",\n                      \"transform\": \"copy\",\n                      \"parameter\": [\n                        {\n                          \"valueId\": \"measurement_date\"\n                        }\n                      ]\n                    }\n                  ]\n                },\n                {\n                  \"name\": \"measurement_type_concept_id\",\n                  \"source\": [\n                    {\n                      \"context\": \"src\",\n                      \"element\": \"id\",\n                      \"variable\": \"measurement_type_concept_id\"\n                    }\n                  ],\n                  \"target\": [\n                    {\n                      \"context\": \"tgt\",\n                      \"element\": \"measurement_type_concept_id\",\n                      \"transform\": \"copy\",\n                      \"parameter\": [\n                        {\n                          \"valueInteger\": 45754907\n                        }\n                      ]\n                    }\n                  ]\n                },\n                {\n                  \"name\": \"measurement_source_value\",\n                  \"source\": [\n                    {\n                      \"context\": \"src\",\n                      \"element\": \"id\",\n                      \"variable\": \"measurement_source_value\"\n                    }\n                  ],\n                  \"target\": [\n                    {\n                      \"context\": \"tgt\",\n                      \"element\": \"measurement_source_value\",\n                      \"transform\": \"copy\",\n                      \"parameter\": [\n                        {\n                          \"valueId\": \"measurement_source_value\"\n                        }\n                      ]\n                    }\n                  ]\n                },\n                {\n                  \"name\": \"mapMeasurementConceptId\",\n                  \"source\": [\n                    {\n                      \"context\": \"qitem\",\n                      \"variable\": \"qitem\"\n                    }\n                  ],\n                  \"rule\": [\n                    {\n                      \"name\": \"mobility\",\n                      \"source\": [\n                        {\n                          \"context\": \"qitem\",\n                          \"variable\": \"mobility\",\n                          \"condition\": \"linkId = 'mobility'\"\n                        }\n                      ],\n                      \"target\": [\n                        {\n                          \"context\": \"tgt\",\n                          \"element\": \"measurement_concept_id\",\n                          \"transform\": \"copy\",\n                          \"parameter\": [\n                            {\n                              \"valueInteger\": 44806412\n                            }\n                          ]\n                        }\n                      ]\n                    },\n                    {\n                      \"name\": \"selfCare\",\n                      \"source\": [\n                        {\n                          \"context\": \"qitem\",\n                          \"variable\": \"selfCare\",\n                          \"condition\": \"linkId = 'self_care'\"\n                        }\n                      ],\n                      \"target\": [\n                        {\n                          \"context\": \"tgt\",\n                          \"element\": \"measurement_concept_id\",\n                          \"transform\": \"copy\",\n                          \"parameter\": [\n                            {\n                              \"valueInteger\": 44806413\n                            }\n                          ]\n                        }\n                      ]\n                    },\n                    {\n                      \"name\": \"usualActivities\",\n                      \"source\": [\n                        {\n                          \"context\": \"qitem\",\n                          \"variable\": \"usualActivities\",\n                          \"condition\": \"linkId = 'usual_activities'\"\n                        }\n                      ],\n                      \"target\": [\n                        {\n                          \"context\": \"tgt\",\n                          \"element\": \"measurement_concept_id\",\n                          \"transform\": \"copy\",\n                          \"parameter\": [\n                            {\n                              \"valueInteger\": 44813555\n                            }\n                          ]\n                        }\n                      ]\n                    },\n                    {\n                      \"name\": \"painDiscomfort\",\n                      \"source\": [\n                        {\n                          \"context\": \"qitem\",\n                          \"variable\": \"painDiscomfort\",\n                          \"condition\": \"linkId = 'pain_discomfort'\"\n                        }\n                      ],\n                      \"target\": [\n                        {\n                          \"context\": \"tgt\",\n                          \"element\": \"measurement_concept_id\",\n                          \"transform\": \"copy\",\n                          \"parameter\": [\n                            {\n                              \"valueInteger\": 44806414\n                            }\n                          ]\n                        }\n                      ]\n                    },\n                    {\n                      \"name\": \"anxietyDepression\",\n                      \"source\": [\n                        {\n                          \"context\": \"qitem\",\n                          \"variable\": \"anxietyDepression\",\n                          \"condition\": \"linkId = 'anxietyDepression'\"\n                        }\n                      ],\n                      \"target\": [\n                        {\n                          \"context\": \"tgt\",\n                          \"element\": \"measurement_concept_id\",\n                          \"transform\": \"copy\",\n                          \"parameter\": [\n                            {\n                              \"valueInteger\": 44813556\n                            }\n                          ]\n                        }\n                      ]\n                    },\n                    {\n                      \"name\": \"eqVAS\",\n                      \"source\": [\n                        {\n                          \"context\": \"qitem\",\n                          \"variable\": \"eqVAS\",\n                          \"condition\": \"linkId = 'eq_vas'\"\n                        }\n                      ],\n                      \"target\": [\n                        {\n                          \"context\": \"tgt\",\n                          \"element\": \"measurement_concept_id\",\n                          \"transform\": \"copy\",\n                          \"parameter\": [\n                            {\n                              \"valueInteger\": 42537274\n                            }\n                          ]\n                        }\n                      ]\n                    }\n                  ]\n                },\n                {\n                  \"name\": \"mapValue\",\n                  \"source\": [\n                    {\n                      \"context\": \"qitem\",\n                      \"variable\": \"qitem\"\n                    }\n                  ],\n                  \"rule\": [\n                    {\n                      \"name\": \"mobility\",\n                      \"source\": [\n                        {\n                          \"context\": \"qitem\",\n                          \"variable\": \"mobility\",\n                          \"condition\": \"linkId = 'mobility'\"\n                        }\n                      ],\n                      \"rule\": [\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '1'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742346\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '2'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742347\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '3'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742348\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '4'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742349\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '5'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742350\n                                }\n                              ]\n                            }\n                          ]\n                        }\n                      ]\n                    },\n                    {\n                      \"name\": \"self_care\",\n                      \"source\": [\n                        {\n                          \"context\": \"qitem\",\n                          \"variable\": \"self_care\",\n                          \"condition\": \"linkId = 'self_care'\"\n                        }\n                      ],\n                      \"rule\": [\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '1'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742351\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '2'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742352\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '3'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742353\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '4'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742354\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '5'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742355\n                                }\n                              ]\n                            }\n                          ]\n                        }\n                      ]\n                    },\n                    {\n                      \"name\": \"usual_activities\",\n                      \"source\": [\n                        {\n                          \"context\": \"qitem\",\n                          \"variable\": \"usual_activities\",\n                          \"condition\": \"linkId = 'usual_activities'\"\n                        }\n                      ],\n                      \"rule\": [\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '1'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742356\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '2'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742357\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '3'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742358\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '4'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742359\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '5'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742360\n                                }\n                              ]\n                            }\n                          ]\n                        }\n                      ]\n                    },\n                    {\n                      \"name\": \"pain_discomfort\",\n                      \"source\": [\n                        {\n                          \"context\": \"qitem\",\n                          \"variable\": \"pain_discomfort\",\n                          \"condition\": \"linkId = 'pain_discomfort'\"\n                        }\n                      ],\n                      \"rule\": [\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '1'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742361\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '2'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742362\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '3'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742363\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '4'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742364\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '5'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742365\n                                }\n                              ]\n                            }\n                          ]\n                        }\n                      ]\n                    },\n                    {\n                      \"name\": \"anxiety_depression\",\n                      \"source\": [\n                        {\n                          \"context\": \"qitem\",\n                          \"variable\": \"anxiety_depression\",\n                          \"condition\": \"linkId = 'anxietyDepression'\"\n                        }\n                      ],\n                      \"rule\": [\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '1'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742366\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '2'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742367\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '3'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742368\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '4'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742369\n                                }\n                              ]\n                            }\n                          ]\n                        },\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"condition\": \"answer.valueCoding.code = '5'\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_concept_id\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueInteger\": 742370\n                                }\n                              ]\n                            }\n                          ]\n                        }\n                      ]\n                    },\n                    {\n                      \"name\": \"eq_vas\",\n                      \"source\": [\n                        {\n                          \"context\": \"qitem\",\n                          \"variable\": \"eq_vas\",\n                          \"condition\": \"linkId = 'eq_vas'\"\n                        }\n                      ],\n                      \"rule\": [\n                        {\n                          \"source\": [\n                            {\n                              \"context\": \"qitem\",\n                              \"element\": \"answer[0].valueInteger\",\n                              \"variable\": \"vasValue\"\n                            }\n                          ],\n                          \"target\": [\n                            {\n                              \"context\": \"tgt\",\n                              \"element\": \"value_as_number\",\n                              \"transform\": \"copy\",\n                              \"parameter\": [\n                                {\n                                  \"valueId\": \"vasValue\"\n                                }\n                              ]\n                            }\n                          ]\n                        }\n                      ]\n                    }\n                  ]\n                }\n              ]\n            }\n          ]\n        }\n      ]\n    }\n  ]\n}",
                "output_omop_data": ""
            },
            "type": "transform_fhir_data_node",
            "width": 350,
            "height": 210,
            "dragging": false,
            "position": {
                "x": -360,
                "y": -180
            },
            "selected": false,
            "dragHandle": "",
            "sourcePosition": "right",
            "targetPosition": "left",
            "positionAbsolute": {
                "x": -360,
                "y": -180
            }
        },
        {
            "id": "cacfa438-5766-4a57-bad2-71b3801bc1b8",
            "data": {
                "name": "insert_into_omop_table",
                "error": false,
                "database": "demo_database",
                "dataframe": "py2table",
                "schemaname": "demo_cdm",
                "dbtablename": "measurement",
                "description": "Insert the records into omop measurement table",
                "errorMessage": null
            },
            "type": "db_writer_node",
            "width": 350,
            "height": 210,
            "dragging": false,
            "position": {
                "x": 1330,
                "y": 10
            },
            "selected": false,
            "dragHandle": "",
            "sourcePosition": "right",
            "targetPosition": "left",
            "positionAbsolute": {
                "x": 1330,
                "y": 10
            }
        },
        {
            "id": "832800a3-c03f-44e0-8a99-9de1a5a3e080",
            "data": {
                "map": {},
                "name": "py2table",
                "error": false,
                "uiMap": {
                    "path": "$",
                    "source": "convert_to_tabular_dataframe"
                },
                "description": "Describe the task of node py2table_node_0",
                "errorMessage": null
            },
            "type": "py2table_node",
            "width": 350,
            "height": 210,
            "dragging": false,
            "position": {
                "x": 790,
                "y": -80
            },
            "selected": false,
            "dragHandle": "",
            "sourcePosition": "right",
            "targetPosition": "left",
            "positionAbsolute": {
                "x": 790,
                "y": -80
            }
        },
        {
            "id": "4a0790fd-2758-470a-8fda-f3e8fdae71f3",
            "data": {
                "name": "convert_to_tabular_dataframe",
                "description": "Convert column wise data to tabular",
                "python_code": "import numpy as np\nimport pandas as pd\n\n\ndef flatten_measurements(df):\n    \"\"\"\n    Flatten a DataFrame where some columns contain lists.\n\n    Args:\n      df: pandas.DataFrame produced from the mapping stage (may contain list-valued columns).\n\n    Behavior:\n      - For each row, expand any list-valued columns into multiple rows (aligned by index).\n      - Skip any flattened row where `measurement_concept_id` is empty (None/NaN/non-convertible).\n      - Set `value_as_number` only when `measurement_concept_id == 42537274`.\n    \"\"\"\n    all_rows = []\n\n    for _, row in df.iterrows():\n        # Save the original row-level value_as_number (if any)\n        row_vas = row.get(\"value_as_number\", None)\n\n        # Determine maximum list length in this row\n        max_len = 0\n        for val in row:\n            if isinstance(val, list):\n                max_len = max(max_len, len(val))\n\n        # If nothing is a list, still produce one output row\n        if max_len == 0:\n            max_len = 1\n\n        for i in range(max_len):\n            entry = {}\n            for col, val in row.items():\n                if isinstance(val, list):\n                    entry[col] = val[i] if i < len(val) else None\n                else:\n                    entry[col] = val\n\n            # Normalize measurement_concept_id\n            meas = entry.get(\"measurement_concept_id\", None)\n\n            # Treat NaN as None\n            if isinstance(meas, float) and np.isnan(meas):\n                meas = None\n\n            # Convert numeric floats to ints\n            if isinstance(meas, (float, np.floating)):\n                try:\n                    meas_int = int(meas)\n                except Exception:\n                    meas_int = None\n                meas = meas_int\n\n            # If measurement_concept_id is empty, skip this flattened row\n            if meas is None:\n                continue\n\n            entry[\"measurement_concept_id\"] = int(meas)\n\n            # Apply value_as_number rule: only for concept 42537274\n            if \"value_as_number\" in entry:\n                entry[\"value_as_number\"] = (\n                    row_vas if entry.get(\"measurement_concept_id\") == 42537274 else None\n                )\n\n            all_rows.append(entry)\n\n    result_df = pd.DataFrame(all_rows)\n    return result_df.reset_index(drop=True)\n\n\ndef exec(myinput):\n    data = myinput.get(\"transform_fhir_to_omop\").result\n    df = flatten_measurements(data)\n    return df\n"
            },
            "type": "python_node",
            "width": 350,
            "height": 210,
            "dragging": false,
            "position": {
                "x": 200,
                "y": -110
            },
            "selected": true,
            "dragHandle": "",
            "sourcePosition": "right",
            "targetPosition": "left",
            "positionAbsolute": {
                "x": 200,
                "y": -110
            }
        }
    ],
    "variables": [],
    "importLibs": []
}
