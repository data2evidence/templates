{
    "name": "ETL fhir to omop",
    "flow": {
        "edges": [
            {
                "id": "reactflow__edge-bc7f2e99-5533-4719-b86a-1a9a83da684fsource_bc7f2e99-5533-4719-b86a-1a9a83da684f_dataframe-6a529d26-128b-49cb-96a2-0f35b4361a78target_6a529d26-128b-49cb-96a2-0f35b4361a78_any",
                "source": "bc7f2e99-5533-4719-b86a-1a9a83da684f",
                "target": "6a529d26-128b-49cb-96a2-0f35b4361a78",
                "sourceHandle": "source_bc7f2e99-5533-4719-b86a-1a9a83da684f_dataframe",
                "targetHandle": "target_6a529d26-128b-49cb-96a2-0f35b4361a78_any"
            },
            {
                "id": "reactflow__edge-6a529d26-128b-49cb-96a2-0f35b4361a78source_6a529d26-128b-49cb-96a2-0f35b4361a78_dataframe-5f6d6ed6-01e1-4186-89cc-6574cd046d40target_5f6d6ed6-01e1-4186-89cc-6574cd046d40_dataframe",
                "source": "6a529d26-128b-49cb-96a2-0f35b4361a78",
                "target": "5f6d6ed6-01e1-4186-89cc-6574cd046d40",
                "selected": false,
                "sourceHandle": "source_6a529d26-128b-49cb-96a2-0f35b4361a78_dataframe",
                "targetHandle": "target_5f6d6ed6-01e1-4186-89cc-6574cd046d40_dataframe"
            },
            {
                "id": "reactflow__edge-b52d463b-e05c-44ad-90a9-7ac912b35314source_b52d463b-e05c-44ad-90a9-7ac912b35314_dataframe-4be69a8a-f90d-4afd-a34b-728b8aa75f6etarget_4be69a8a-f90d-4afd-a34b-728b8aa75f6e_dataframe",
                "source": "b52d463b-e05c-44ad-90a9-7ac912b35314",
                "target": "4be69a8a-f90d-4afd-a34b-728b8aa75f6e",
                "sourceHandle": "source_b52d463b-e05c-44ad-90a9-7ac912b35314_dataframe",
                "targetHandle": "target_4be69a8a-f90d-4afd-a34b-728b8aa75f6e_dataframe"
            },
            {
                "id": "reactflow__edge-4be69a8a-f90d-4afd-a34b-728b8aa75f6esource_4be69a8a-f90d-4afd-a34b-728b8aa75f6e_dataframe-4b92d9e9-6a59-459f-8fc5-5a8ff5824bcatarget_4b92d9e9-6a59-459f-8fc5-5a8ff5824bca_dataframe",
                "source": "4be69a8a-f90d-4afd-a34b-728b8aa75f6e",
                "target": "4b92d9e9-6a59-459f-8fc5-5a8ff5824bca",
                "sourceHandle": "source_4be69a8a-f90d-4afd-a34b-728b8aa75f6e_dataframe",
                "targetHandle": "target_4b92d9e9-6a59-459f-8fc5-5a8ff5824bca_dataframe"
            },
            {
                "id": "reactflow__edge-4a4209c6-84f1-4afe-85a6-2c3aecfee44bsource_4a4209c6-84f1-4afe-85a6-2c3aecfee44b_dataframe-ccd0ebd8-3149-47ce-b201-13fccdcd9ac6target_ccd0ebd8-3149-47ce-b201-13fccdcd9ac6_dataframe",
                "source": "4a4209c6-84f1-4afe-85a6-2c3aecfee44b",
                "target": "ccd0ebd8-3149-47ce-b201-13fccdcd9ac6",
                "sourceHandle": "source_4a4209c6-84f1-4afe-85a6-2c3aecfee44b_dataframe",
                "targetHandle": "target_ccd0ebd8-3149-47ce-b201-13fccdcd9ac6_dataframe"
            },
            {
                "id": "reactflow__edge-ccd0ebd8-3149-47ce-b201-13fccdcd9ac6source_ccd0ebd8-3149-47ce-b201-13fccdcd9ac6_dataframe-5b177aca-870c-4745-95e1-6305ee390261target_5b177aca-870c-4745-95e1-6305ee390261_dataframe",
                "source": "ccd0ebd8-3149-47ce-b201-13fccdcd9ac6",
                "target": "5b177aca-870c-4745-95e1-6305ee390261",
                "sourceHandle": "source_ccd0ebd8-3149-47ce-b201-13fccdcd9ac6_dataframe",
                "targetHandle": "target_5b177aca-870c-4745-95e1-6305ee390261_dataframe"
            },
            {
                "id": "reactflow__edge-fcab0880-2901-49fb-8e3c-e73735a07030source_fcab0880-2901-49fb-8e3c-e73735a07030_dataframe-1aa813ea-bb41-4d13-bfbf-3ce1e45be964target_1aa813ea-bb41-4d13-bfbf-3ce1e45be964_dataframe",
                "source": "fcab0880-2901-49fb-8e3c-e73735a07030",
                "target": "1aa813ea-bb41-4d13-bfbf-3ce1e45be964",
                "sourceHandle": "source_fcab0880-2901-49fb-8e3c-e73735a07030_dataframe",
                "targetHandle": "target_1aa813ea-bb41-4d13-bfbf-3ce1e45be964_dataframe"
            },
            {
                "id": "reactflow__edge-1aa813ea-bb41-4d13-bfbf-3ce1e45be964source_1aa813ea-bb41-4d13-bfbf-3ce1e45be964_dataframe-c59e95aa-1642-4f04-a07d-c19a496aca91target_c59e95aa-1642-4f04-a07d-c19a496aca91_dataframe",
                "source": "1aa813ea-bb41-4d13-bfbf-3ce1e45be964",
                "target": "c59e95aa-1642-4f04-a07d-c19a496aca91",
                "sourceHandle": "source_1aa813ea-bb41-4d13-bfbf-3ce1e45be964_dataframe",
                "targetHandle": "target_c59e95aa-1642-4f04-a07d-c19a496aca91_dataframe"
            },
            {
                "id": "reactflow__edge-97d2d719-131e-4e91-9965-5dacc4f77bbasource_97d2d719-131e-4e91-9965-5dacc4f77bba_dataframe-e9547ad0-a803-407e-82e6-c8f5f474b9b2target_e9547ad0-a803-407e-82e6-c8f5f474b9b2_dataframe",
                "source": "97d2d719-131e-4e91-9965-5dacc4f77bba",
                "target": "e9547ad0-a803-407e-82e6-c8f5f474b9b2",
                "sourceHandle": "source_97d2d719-131e-4e91-9965-5dacc4f77bba_dataframe",
                "targetHandle": "target_e9547ad0-a803-407e-82e6-c8f5f474b9b2_dataframe"
            },
            {
                "id": "reactflow__edge-e9547ad0-a803-407e-82e6-c8f5f474b9b2source_e9547ad0-a803-407e-82e6-c8f5f474b9b2_dataframe-b3e0cbd2-1680-4d5a-8a58-a74d636f1696target_b3e0cbd2-1680-4d5a-8a58-a74d636f1696_dataframe",
                "source": "e9547ad0-a803-407e-82e6-c8f5f474b9b2",
                "target": "b3e0cbd2-1680-4d5a-8a58-a74d636f1696",
                "sourceHandle": "source_e9547ad0-a803-407e-82e6-c8f5f474b9b2_dataframe",
                "targetHandle": "target_b3e0cbd2-1680-4d5a-8a58-a74d636f1696_dataframe"
            },
            {
                "id": "reactflow__edge-644c6dc1-72bf-4f5b-8a64-620407a36e3asource_644c6dc1-72bf-4f5b-8a64-620407a36e3a_dataframe-6fbd33f7-bad1-43ab-85db-f2e8a2e07883target_6fbd33f7-bad1-43ab-85db-f2e8a2e07883_dataframe",
                "source": "644c6dc1-72bf-4f5b-8a64-620407a36e3a",
                "target": "6fbd33f7-bad1-43ab-85db-f2e8a2e07883",
                "sourceHandle": "source_644c6dc1-72bf-4f5b-8a64-620407a36e3a_dataframe",
                "targetHandle": "target_6fbd33f7-bad1-43ab-85db-f2e8a2e07883_dataframe"
            },
            {
                "id": "reactflow__edge-6fbd33f7-bad1-43ab-85db-f2e8a2e07883source_6fbd33f7-bad1-43ab-85db-f2e8a2e07883_dataframe-9fff2d40-4802-46a6-9e9a-7615c47b7754target_9fff2d40-4802-46a6-9e9a-7615c47b7754_dataframe",
                "source": "6fbd33f7-bad1-43ab-85db-f2e8a2e07883",
                "target": "9fff2d40-4802-46a6-9e9a-7615c47b7754",
                "sourceHandle": "source_6fbd33f7-bad1-43ab-85db-f2e8a2e07883_dataframe",
                "targetHandle": "target_9fff2d40-4802-46a6-9e9a-7615c47b7754_dataframe"
            },
            {
                "id": "reactflow__edge-140dffdd-9b98-46a7-ae23-b2b8a6a79a4esource_140dffdd-9b98-46a7-ae23-b2b8a6a79a4e_dataframe-a168686a-8581-4f76-a6cf-a60b85187c4ctarget_a168686a-8581-4f76-a6cf-a60b85187c4c_dataframe",
                "source": "140dffdd-9b98-46a7-ae23-b2b8a6a79a4e",
                "target": "a168686a-8581-4f76-a6cf-a60b85187c4c",
                "sourceHandle": "source_140dffdd-9b98-46a7-ae23-b2b8a6a79a4e_dataframe",
                "targetHandle": "target_a168686a-8581-4f76-a6cf-a60b85187c4c_dataframe"
            },
            {
                "id": "reactflow__edge-a168686a-8581-4f76-a6cf-a60b85187c4csource_a168686a-8581-4f76-a6cf-a60b85187c4c_dataframe-345c3710-002f-4c6d-843b-94e873927548target_345c3710-002f-4c6d-843b-94e873927548_dataframe",
                "source": "a168686a-8581-4f76-a6cf-a60b85187c4c",
                "target": "345c3710-002f-4c6d-843b-94e873927548",
                "sourceHandle": "source_a168686a-8581-4f76-a6cf-a60b85187c4c_dataframe",
                "targetHandle": "target_345c3710-002f-4c6d-843b-94e873927548_dataframe"
            },
            {
                "id": "reactflow__edge-c1e62222-8885-4467-811f-52e80cf4e3b6source_c1e62222-8885-4467-811f-52e80cf4e3b6_dataframe-befd2a41-c7a2-4494-b02b-6817ea042919target_befd2a41-c7a2-4494-b02b-6817ea042919_dataframe",
                "source": "c1e62222-8885-4467-811f-52e80cf4e3b6",
                "target": "befd2a41-c7a2-4494-b02b-6817ea042919",
                "sourceHandle": "source_c1e62222-8885-4467-811f-52e80cf4e3b6_dataframe",
                "targetHandle": "target_befd2a41-c7a2-4494-b02b-6817ea042919_dataframe"
            },
            {
                "id": "reactflow__edge-befd2a41-c7a2-4494-b02b-6817ea042919source_befd2a41-c7a2-4494-b02b-6817ea042919_dataframe-a51a4106-095e-49a8-a868-db5874ed60f5target_a51a4106-095e-49a8-a868-db5874ed60f5_dataframe",
                "source": "befd2a41-c7a2-4494-b02b-6817ea042919",
                "target": "a51a4106-095e-49a8-a868-db5874ed60f5",
                "sourceHandle": "source_befd2a41-c7a2-4494-b02b-6817ea042919_dataframe",
                "targetHandle": "target_a51a4106-095e-49a8-a868-db5874ed60f5_dataframe"
            },
            {
                "id": "reactflow__edge-230782cf-935e-4354-9c89-db8a2f37bf99source_230782cf-935e-4354-9c89-db8a2f37bf99_dataframe-e0691f92-eb19-4657-a9da-c0eae7974288target_e0691f92-eb19-4657-a9da-c0eae7974288_dataframe",
                "source": "230782cf-935e-4354-9c89-db8a2f37bf99",
                "target": "e0691f92-eb19-4657-a9da-c0eae7974288",
                "sourceHandle": "source_230782cf-935e-4354-9c89-db8a2f37bf99_dataframe",
                "targetHandle": "target_e0691f92-eb19-4657-a9da-c0eae7974288_dataframe"
            },
            {
                "id": "reactflow__edge-e0691f92-eb19-4657-a9da-c0eae7974288source_e0691f92-eb19-4657-a9da-c0eae7974288_dataframe-cf76f9a9-321b-469f-8779-fc8945fd50f6target_cf76f9a9-321b-469f-8779-fc8945fd50f6_dataframe",
                "source": "e0691f92-eb19-4657-a9da-c0eae7974288",
                "target": "cf76f9a9-321b-469f-8779-fc8945fd50f6",
                "sourceHandle": "source_e0691f92-eb19-4657-a9da-c0eae7974288_dataframe",
                "targetHandle": "target_cf76f9a9-321b-469f-8779-fc8945fd50f6_dataframe"
            }
        ],
        "nodes": [
            {
                "id": "6a529d26-128b-49cb-96a2-0f35b4361a78",
                "data": {
                    "id": "AllergeMap",
                    "name": "transform_allergy_to_observation",
                    "error": false,
                    "result": "{\n  \"error\": false,\n  \"errorMessage\": null,\n  \"nodeName\": \"transform_allergy_to_observation\",\n  \"length\": 2,\n  \"type\": \"<class 'pandas.core.frame.DataFrame'>\",\n  \"schema\": {\n    \"observation_id\": \"int64\",\n    \"person_id\": \"object\",\n    \"observation_concept_id\": \"int64\",\n    \"observation_source_value\": \"object\",\n    \"observation_source_concept_id\": \"object\",\n    \"observation_date\": \"object\",\n    \"observation_datetime\": \"object\",\n    \"observation_type_concept_id\": \"int64\"\n  }\n}",
                    "dataframe": "get_allergyIntolerance_fhir_data",
                    "description": "Transform fhir to omop with structure map",
                    "errorMessage": null,
                    "structure_map": {
                        "id": "AllergyMap",
                        "url": "http://hl7.org/fhir/uv/omop/StructureMap/AllergyMap",
                        "date": "2025-07-29T17:40:15+00:00",
                        "name": "AllergyMap",
                        "text": {
                            "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><p class=\"res-header-id\"><b>Generated Narrative: StructureMap AllergyMap</b></p><a name=\"AllergyMap\"> </a><a name=\"hcAllergyMap\"> </a><pre class=\"fml\">\r\n<span style=\"color: #cc00cc\">/// <b>url</b> = </span><span style=\"color: blue\">'http://hl7.org/fhir/uv/omop/StructureMap/AllergyMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>name</b> = </span><span style=\"color: blue\">'AllergyMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>title</b> = </span><span style=\"color: blue\">'Mapping Allergy resource to Observation OMOP Domain'</span>\r\n<span style=\"color: #cc00cc\">/// <b>status</b> = </span><span style=\"color: blue\">'draft'</span>\r\n\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"http://hl7.org/fhir/R5/allergyintolerance.html\" title=\"AllergyIntolerance\">http://hl7.org/fhir/StructureDefinition/AllergyIntolerance</a><span style=\"color: navy\">&quot; </span><b>alias </b>Allergy <b>as </b><b>source</b>\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"StructureDefinition-Observation.html\" title=\"Observation OMOP Table\">http://hl7.org/fhir/uv/omop/StructureDefinition/Observation</a><span style=\"color: navy\">&quot; </span><b>alias </b>ObservationTable <b>as </b><b>target</b>\r\n\r\n<b>group </b>Observation<span style=\"color: navy\">(</span><b>source</b> <span style=\"color: maroon\">src</span><span style=\"color: navy\"> : </span>Allergy, <b>target</b> <span style=\"color: maroon\">tgt</span><span style=\"color: navy\"> : </span>ObservationTable<span style=\"color: navy\">)</span><span style=\"color: navy\"> {\r\n</span>  src.code<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      sc.code<span style=\"color: navy\"><b> -&gt; </b></span> tgt.observation_concept_id<span style=\"color: navy\">, </span> tgt.observation_source_value<span style=\"color: navy\">, </span> tgt.observation_source_concept_id<span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.id as id -&gt; tgt.observation_id = cast(id, &quot;integer&quot;);</span>\r\n  src.onset<span style=\"color: navy\"> : </span>dateTime<b> as </b><span style=\"color: maroon\">osd</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.observation_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">osd</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">, </span> tgt.observation_datetime = <span style=\"color: maroon\">osd</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.patient as s -&gt; tgt then {</span>\r\n  src.reaction<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.manifestation<b> as </b><span style=\"color: maroon\">sman</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      sman.concept<b> as </b><span style=\"color: maroon\">smanc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>        smanc.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>          sc.code<span style=\"color: navy\"><b> -&gt; </b></span> tgt.value_as_concept_id<span style=\"color: navy\">, </span> tgt.value_source_value<span style=\"color: navy\">;</span>\r\n        <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n      <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n<span style=\"color: navy\">}\r\n\r\n</span></pre></div>",
                            "status": "generated"
                        },
                        "group": [
                            {
                                "name": "Observation",
                                "rule": [
                                    {
                                        "name": "mapObservationId",
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "id",
                                                "variable": "fhirId"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "observation_id",
                                                "parameter": [
                                                    {
                                                        "valueId": "fhirId"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ],
                                        "documentation": "Generate a unique OMOP observation_id."
                                    },
                                    {
                                        "name": "mapPatientId",
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "patient.reference",
                                                "variable": "patRef"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "person_id",
                                                "parameter": [
                                                    {
                                                        "valueId": "patRef"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "code",
                                        "rule": [
                                            {
                                                "name": "coding",
                                                "rule": [
                                                    {
                                                        "name": "code",
                                                        "source": [
                                                            {
                                                                "context": "sc",
                                                                "element": "code",
                                                                "variable": "sc_code"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "observation_concept_id",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "sc_code"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            },
                                                            {
                                                                "context": "tgt",
                                                                "element": "observation_source_value",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "sc_code"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            },
                                                            {
                                                                "context": "tgt",
                                                                "element": "observation_source_concept_id",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "sc_code"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "coding",
                                                        "variable": "sc"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "parameter": [
                                                            {
                                                                "valueId": "sc"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "code",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ],
                                        "documentation": "src.id as id -> tgt.observation_id = cast(id, \"integer\");"
                                    },
                                    {
                                        "name": "onsetDateTime",
                                        "source": [
                                            {
                                                "type": "dateTime",
                                                "context": "src",
                                                "element": "onset",
                                                "variable": "osd"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "observation_date",
                                                "parameter": [
                                                    {
                                                        "valueId": "osd"
                                                    },
                                                    {
                                                        "valueString": "date"
                                                    }
                                                ],
                                                "transform": "copy"
                                            },
                                            {
                                                "context": "tgt",
                                                "element": "observation_datetime",
                                                "parameter": [
                                                    {
                                                        "valueId": "osd"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ],
                                        "documentation": "src.patient as s -> tgt then {"
                                    },
                                    {
                                        "name": "mapObservationTypeConceptId",
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "recorder",
                                                "variable": "rec"
                                            },
                                            {
                                                "context": "src",
                                                "element": "asserter",
                                                "variable": "asserter"
                                            },
                                            {
                                                "context": "src",
                                                "element": "meta.source",
                                                "variable": "srcSys"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "observation_type_concept_id",
                                                "parameter": [
                                                    {
                                                        "valueId": "rec"
                                                    },
                                                    {
                                                        "valueId": "asserter"
                                                    },
                                                    {
                                                        "valueId": "srcSys"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ],
                                        "documentation": "Derive OMOP observation_type_concept_id based on FHIR AllergyIntolerance provenance."
                                    }
                                ],
                                "input": [
                                    {
                                        "mode": "source",
                                        "name": "src",
                                        "type": "Allergy"
                                    },
                                    {
                                        "mode": "target",
                                        "name": "tgt",
                                        "type": "ObservationTable"
                                    }
                                ]
                            }
                        ],
                        "title": "Mapping Allergy resource to Observation OMOP Domain",
                        "status": "draft",
                        "contact": [
                            {
                                "name": "HL7 International / Biomedical Research and Regulation",
                                "telecom": [
                                    {
                                        "value": "http://www.hl7.org/Special/committees/rcrim",
                                        "system": "url"
                                    }
                                ]
                            }
                        ],
                        "version": "1.0.0-ballot",
                        "extension": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-wg",
                                "valueCode": "brr"
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-fmm",
                                "valueInteger": 1,
                                "_valueInteger": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-standards-status",
                                "valueCode": "informative",
                                "_valueCode": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            }
                        ],
                        "publisher": "HL7 International / Biomedical Research and Regulation",
                        "structure": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/AllergyIntolerance",
                                "mode": "source",
                                "alias": "Allergy"
                            },
                            {
                                "url": "http://hl7.org/fhir/uv/omop/StructureDefinition/Observation",
                                "mode": "target",
                                "alias": "ObservationTable"
                            }
                        ],
                        "description": "This mapping maps FHIR AllergyIntolerance instances to OMOP Observation Table objects.",
                        "jurisdiction": [
                            {
                                "coding": [
                                    {
                                        "code": "001",
                                        "system": "http://unstats.un.org/unsd/methods/m49/m49.htm",
                                        "display": "World"
                                    }
                                ]
                            }
                        ],
                        "resourceType": "StructureMap"
                    },
                    "output_omop_data": ""
                },
                "type": "transform_data_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 130,
                    "y": 100
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 130,
                    "y": 100
                }
            },
            {
                "id": "bc7f2e99-5533-4719-b86a-1a9a83da684f",
                "data": {
                    "name": "get_allergyIntolerance_fhir_data",
                    "error": false,
                    "result": "{\n  \"error\": false,\n  \"errorMessage\": null,\n  \"nodeName\": \"get_allergyIntolerance_fhir_data\",\n  \"length\": 2,\n  \"type\": \"<class 'pandas.core.frame.DataFrame'>\",\n  \"schema\": {\n    \"content\": \"object\"\n  }\n}",
                    "database": "alp_fhir",
                    "sqlquery": "select content from \"fhir\".\"AllergyIntolerance\"",
                    "testdata": [
                        []
                    ],
                    "description": "Get fhir data for AllergyIntolerance resource",
                    "errorMessage": null
                },
                "type": "db_reader_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": -370,
                    "y": 60
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": -370,
                    "y": 60
                }
            },
            {
                "id": "5f6d6ed6-01e1-4186-89cc-6574cd046d40",
                "data": {
                    "name": "insert_into_omop_observation",
                    "error": false,
                    "result": "{\n  \"error\": false,\n  \"errorMessage\": null,\n  \"nodeName\": \"insert_into_omop_observation\",\n  \"length\": null,\n  \"type\": \"<class 'int'>\"\n}",
                    "database": "alpdev_pg",
                    "dataframe": "transform_allergy_to_observation",
                    "schemaname": "cdm_ds1_1761010593",
                    "dbtablename": "observation",
                    "description": "Insert into omop cdm database table",
                    "errorMessage": null
                },
                "type": "db_writer_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 610,
                    "y": 120
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 610,
                    "y": 120
                }
            },
            {
                "id": "b52d463b-e05c-44ad-90a9-7ac912b35314",
                "data": {
                    "name": "get_patient_fhir_data",
                    "error": false,
                    "result": "{\n  \"error\": false,\n  \"errorMessage\": null,\n  \"nodeName\": \"get_patient_fhir_data\",\n  \"length\": 1,\n  \"type\": \"<class 'pandas.core.frame.DataFrame'>\",\n  \"schema\": {\n    \"content\": \"object\"\n  }\n}",
                    "database": "alp_fhir",
                    "sqlquery": "select content from \"fhir\".\"Patient\"",
                    "testdata": [
                        []
                    ],
                    "description": "Get fhir data for Patient resource",
                    "errorMessage": null
                },
                "type": "db_reader_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": -380,
                    "y": 480
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": -380,
                    "y": 480
                }
            },
            {
                "id": "4be69a8a-f90d-4afd-a34b-728b8aa75f6e",
                "data": {
                    "id": "PersonMap",
                    "name": "transform_fhir_omop_patient",
                    "error": false,
                    "result": "{\n  \"error\": false,\n  \"errorMessage\": null,\n  \"nodeName\": \"transform_fhir_omop_patient\",\n  \"length\": 1,\n  \"type\": \"<class 'pandas.core.frame.DataFrame'>\",\n  \"schema\": {}\n}",
                    "dataframe": "get_patient_fhir_data",
                    "description": "Describe the task of node transform_data_node_1",
                    "errorMessage": null,
                    "structure_map": {
                        "id": "PersonMap",
                        "url": "http://hl7.org/fhir/uv/omop/StructureMap/PersonMap",
                        "date": "2025-07-29T17:40:15+00:00",
                        "name": "PersonMap",
                        "text": {
                            "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><p class=\"res-header-id\"><b>Generated Narrative: StructureMap PersonMap</b></p><a name=\"PersonMap\"> </a><a name=\"hcPersonMap\"> </a><pre class=\"fml\">\r\n<span style=\"color: #cc00cc\">/// <b>url</b> = </span><span style=\"color: blue\">'http://hl7.org/fhir/uv/omop/StructureMap/PersonMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>name</b> = </span><span style=\"color: blue\">'PersonMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>title</b> = </span><span style=\"color: blue\">'Mapping Patient resource to Person OMOP Domain'</span>\r\n<span style=\"color: #cc00cc\">/// <b>status</b> = </span><span style=\"color: blue\">'draft'</span>\r\n\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"http://hl7.org/fhir/R5/patient.html\" title=\"Patient\">http://hl7.org/fhir/StructureDefinition/Patient</a><span style=\"color: navy\">&quot; </span><b>alias </b>Patient <b>as </b><b>source</b>\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"StructureDefinition-Person.html\" title=\"Person OMOP Table\">http://hl7.org/fhir/uv/omop/StructureDefinition/Person</a><span style=\"color: navy\">&quot; </span><b>alias </b>PersonTable <b>as </b><b>target</b>\r\n\r\n<b>group </b>Person<span style=\"color: navy\">(</span><b>source</b> <span style=\"color: maroon\">src</span><span style=\"color: navy\"> : </span>Patient, <b>target</b> <span style=\"color: maroon\">tgt</span><span style=\"color: navy\"> : </span>PersonTable<span style=\"color: navy\">)</span><span style=\"color: navy\"> {\r\n</span>  src.gender<b> as </b><span style=\"color: maroon\">gender</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.gender_concept_id = <span style=\"color: maroon\">gender</span><span style=\"color: navy\">, </span> tgt.gender_source_value = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">gender</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'string'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.id as id -&gt; tgt.person_id = cast(id, &quot;integer&quot;);</span>\r\n  src.birthDate<b> as </b><span style=\"color: maroon\">bdSrc</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.birth_datetime = <span style=\"color: maroon\">bdSrc</span><span style=\"color: navy\">, </span> tgt.year_of_birth = <span style=\"color: navy\">(</span>src.birthDate.toString().substring(0, 4)<span style=\"color: navy\">)</span><span style=\"color: navy\">, </span> tgt.month_of_birth = <span style=\"color: navy\">(</span>src.birthDate.toString().substring(5, 2)<span style=\"color: navy\">)</span><span style=\"color: navy\">, </span> tgt.day_of_birth = <span style=\"color: navy\">(</span>src.birthDate.toString().substring(8, 2)<span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n<span style=\"color: navy\">}\r\n\r\n</span></pre></div>",
                            "status": "generated"
                        },
                        "group": [
                            {
                                "name": "Person",
                                "rule": [
                                    {
                                        "name": "person_id",
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "id",
                                                "variable": "patientId"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "person_id",
                                                "parameter": [
                                                    {
                                                        "valueId": "patientId"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "gender",
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "gender",
                                                "variable": "gender"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "gender_concept_id",
                                                "parameter": [
                                                    {
                                                        "valueId": "gender"
                                                    }
                                                ],
                                                "transform": "copy"
                                            },
                                            {
                                                "context": "tgt",
                                                "element": "gender_source_value",
                                                "parameter": [
                                                    {
                                                        "valueId": "gender"
                                                    },
                                                    {
                                                        "valueString": "string"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ],
                                        "documentation": "src.id as id -> tgt.person_id = cast(id, \"integer\");"
                                    },
                                    {
                                        "name": "birthDate",
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "birthDate",
                                                "variable": "bdSrc"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "birth_datetime",
                                                "parameter": [
                                                    {
                                                        "valueId": "bdSrc"
                                                    }
                                                ],
                                                "transform": "copy"
                                            },
                                            {
                                                "context": "tgt",
                                                "element": "year_of_birth",
                                                "parameter": [
                                                    {
                                                        "valueId": "src"
                                                    },
                                                    {
                                                        "valueString": "birthDate.substring(0,4)"
                                                    }
                                                ],
                                                "transform": "evaluate"
                                            },
                                            {
                                                "context": "tgt",
                                                "element": "month_of_birth",
                                                "parameter": [
                                                    {
                                                        "valueId": "src"
                                                    },
                                                    {
                                                        "valueString": "birthDate.substring(5,2)"
                                                    }
                                                ],
                                                "transform": "evaluate"
                                            },
                                            {
                                                "context": "tgt",
                                                "element": "day_of_birth",
                                                "parameter": [
                                                    {
                                                        "valueId": "src"
                                                    },
                                                    {
                                                        "valueString": "birthDate.substring(8,2)"
                                                    }
                                                ],
                                                "transform": "evaluate"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "raceConcept",
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "extension.where(url = 'http://hl7.org/fhir/us/core/StructureDefinition/us-core-race').extension.valueCoding.display",
                                                "variable": "race"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "race_concept_id",
                                                "parameter": [
                                                    {
                                                        "valueId": "race"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "ethnicity_concept_id",
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "extension.where(url = 'http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity').extension.where(url = 'ombCategory').valueCoding.code",
                                                "variable": "ethnicityCode"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "ethnicity_concept_id",
                                                "parameter": [
                                                    {
                                                        "valueId": "ethnicityCode"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ],
                                        "documentation": "Map FHIR US Core ethnicity extension to OMOP person.ethnicity_concept_id"
                                    }
                                ],
                                "input": [
                                    {
                                        "mode": "source",
                                        "name": "src",
                                        "type": "Patient"
                                    },
                                    {
                                        "mode": "target",
                                        "name": "tgt",
                                        "type": "PersonTable"
                                    }
                                ]
                            }
                        ],
                        "title": "Mapping Patient resource to Person OMOP Domain",
                        "status": "draft",
                        "contact": [
                            {
                                "name": "HL7 International / Biomedical Research and Regulation",
                                "telecom": [
                                    {
                                        "value": "http://www.hl7.org/Special/committees/rcrim",
                                        "system": "url"
                                    }
                                ]
                            }
                        ],
                        "version": "1.0.0-ballot",
                        "extension": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-wg",
                                "valueCode": "brr"
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-fmm",
                                "valueInteger": 1,
                                "_valueInteger": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-standards-status",
                                "valueCode": "informative",
                                "_valueCode": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            }
                        ],
                        "publisher": "HL7 International / Biomedical Research and Regulation",
                        "structure": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/Patient",
                                "mode": "source",
                                "alias": "Patient"
                            },
                            {
                                "url": "http://hl7.org/fhir/uv/omop/StructureDefinition/Person",
                                "mode": "target",
                                "alias": "PersonTable"
                            }
                        ],
                        "description": "This mapping maps FHIR Patient instances to OMOP Person Table objects.",
                        "jurisdiction": [
                            {
                                "coding": [
                                    {
                                        "code": "001",
                                        "system": "http://unstats.un.org/unsd/methods/m49/m49.htm",
                                        "display": "World"
                                    }
                                ]
                            }
                        ],
                        "resourceType": "StructureMap"
                    },
                    "output_omop_data": ""
                },
                "type": "transform_data_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 150,
                    "y": 450
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 150,
                    "y": 450
                }
            },
            {
                "id": "4b92d9e9-6a59-459f-8fc5-5a8ff5824bca",
                "data": {
                    "name": "Insert_into_omop_person",
                    "error": true,
                    "result": "{\n  \"error\": true,\n  \"errorMessage\": \"Traceback (most recent call last):\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\\\", line 1964, in _exec_single_context\\n    self.dialect.do_execute(\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py\\\", line 942, in do_execute\\n    cursor.execute(statement, parameters)\\npsycopg2.errors.NotNullViolation: null value in column \\\"condition_occurrence_id\\\" of relation \\\"condition_occurrence\\\" violates not-null constraint\\nDETAIL:  Failing row contains (null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null).\\n\\n\\nThe above exception was the direct cause of the following exception:\\n\\nTraceback (most recent call last):\\n  File \\\"/app/flows/dataflow_ui_plugin/nodes.py\\\", line 468, in task\\n    result = df_to_write.to_sql(self.table_name,\\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/util/_decorators.py\\\", line 333, in wrapper\\n    return func(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/core/generic.py\\\", line 3087, in to_sql\\n    return sql.to_sql(\\n           ^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\\\", line 842, in to_sql\\n    return pandas_sql.to_sql(\\n           ^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\\\", line 2018, in to_sql\\n    total_inserted = sql_engine.insert_records(\\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\\\", line 1567, in insert_records\\n    raise err\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\\\", line 1558, in insert_records\\n    return table.insert(chunksize=chunksize, method=method)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\\\", line 1119, in insert\\n    num_inserted = exec_insert(conn, keys, chunk_iter)\\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\\\", line 1010, in _execute_insert\\n    result = conn.execute(self.table.insert(), data)\\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\\\", line 1416, in execute\\n    return meth(\\n           ^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py\\\", line 516, in _execute_on_connection\\n    return connection._execute_clauseelement(\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\\\", line 1638, in _execute_clauseelement\\n    ret = self._execute_context(\\n          ^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\\\", line 1843, in _execute_context\\n    return self._exec_single_context(\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\\\", line 1983, in _exec_single_context\\n    self._handle_dbapi_exception(\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\\\", line 2352, in _handle_dbapi_exception\\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\\\", line 1964, in _exec_single_context\\n    self.dialect.do_execute(\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py\\\", line 942, in do_execute\\n    cursor.execute(statement, parameters)\\nsqlalchemy.exc.IntegrityError: (psycopg2.errors.NotNullViolation) null value in column \\\"condition_occurrence_id\\\" of relation \\\"condition_occurrence\\\" violates not-null constraint\\nDETAIL:  Failing row contains (null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null).\\n\\n[SQL: INSERT INTO cdm_ds1_1761010593.condition_occurrence DEFAULT VALUES]\\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\\n\",\n  \"nodeName\": \"Insert_into_omop_person\"\n}",
                    "database": "alpdev_pg",
                    "dataframe": "transform_fhir_omop_patient",
                    "schemaname": "cdm_ds1_1761010593",
                    "dbtablename": "person",
                    "description": "Insert into cdm omop database",
                    "errorMessage": "Traceback (most recent call last):\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1964, in _exec_single_context\n    self.dialect.do_execute(\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py\", line 942, in do_execute\n    cursor.execute(statement, parameters)\npsycopg2.errors.NotNullViolation: null value in column \"condition_occurrence_id\" of relation \"condition_occurrence\" violates not-null constraint\nDETAIL:  Failing row contains (null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null).\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/app/flows/dataflow_ui_plugin/nodes.py\", line 468, in task\n    result = df_to_write.to_sql(self.table_name,\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/util/_decorators.py\", line 333, in wrapper\n    return func(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/core/generic.py\", line 3087, in to_sql\n    return sql.to_sql(\n           ^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\", line 842, in to_sql\n    return pandas_sql.to_sql(\n           ^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\", line 2018, in to_sql\n    total_inserted = sql_engine.insert_records(\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\", line 1567, in insert_records\n    raise err\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\", line 1558, in insert_records\n    return table.insert(chunksize=chunksize, method=method)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\", line 1119, in insert\n    num_inserted = exec_insert(conn, keys, chunk_iter)\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\", line 1010, in _execute_insert\n    result = conn.execute(self.table.insert(), data)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1416, in execute\n    return meth(\n           ^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py\", line 516, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1638, in _execute_clauseelement\n    ret = self._execute_context(\n          ^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1843, in _execute_context\n    return self._exec_single_context(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1983, in _exec_single_context\n    self._handle_dbapi_exception(\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 2352, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1964, in _exec_single_context\n    self.dialect.do_execute(\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py\", line 942, in do_execute\n    cursor.execute(statement, parameters)\nsqlalchemy.exc.IntegrityError: (psycopg2.errors.NotNullViolation) null value in column \"condition_occurrence_id\" of relation \"condition_occurrence\" violates not-null constraint\nDETAIL:  Failing row contains (null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null).\n\n[SQL: INSERT INTO cdm_ds1_1761010593.condition_occurrence DEFAULT VALUES]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\n"
                },
                "type": "db_writer_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 610,
                    "y": 440
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 610,
                    "y": 440
                }
            },
            {
                "id": "4a4209c6-84f1-4afe-85a6-2c3aecfee44b",
                "data": {
                    "name": "get_condition_fhir_data",
                    "error": false,
                    "result": "{\n  \"error\": false,\n  \"errorMessage\": null,\n  \"nodeName\": \"get_condition_fhir_data\",\n  \"length\": 1,\n  \"type\": \"<class 'pandas.core.frame.DataFrame'>\",\n  \"schema\": {\n    \"content\": \"object\"\n  }\n}",
                    "database": "alp_fhir",
                    "sqlquery": "select content from \"fhir\".\"Condition\"",
                    "testdata": [
                        []
                    ],
                    "description": "Get fhir data for Condition resource",
                    "errorMessage": null
                },
                "type": "db_reader_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": -360,
                    "y": 920
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": -360,
                    "y": 920
                }
            },
            {
                "id": "ccd0ebd8-3149-47ce-b201-13fccdcd9ac6",
                "data": {
                    "id": "ConditionMap",
                    "name": "transform_fhir_omop_patient",
                    "dataframe": "get_patient_fhir_data",
                    "description": "Transform condition fhir resource to condition_occurrence omop table",
                    "structure_map": {
                        "id": "ConditionMap",
                        "url": "http://hl7.org/fhir/uv/omop/StructureMap/ConditionMap",
                        "date": "2025-07-29T17:40:15+00:00",
                        "name": "ConditionMap",
                        "text": {
                            "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><p class=\"res-header-id\"><b>Generated Narrative: StructureMap ConditionMap</b></p><a name=\"ConditionMap\"> </a><a name=\"hcConditionMap\"> </a><pre class=\"fml\">\r\n<span style=\"color: #cc00cc\">/// <b>url</b> = </span><span style=\"color: blue\">'http://hl7.org/fhir/uv/omop/StructureMap/ConditionMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>name</b> = </span><span style=\"color: blue\">'ConditionMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>title</b> = </span><span style=\"color: blue\">'Mapping Condition resource to Condition Occurrence OMOP Domain'</span>\r\n<span style=\"color: #cc00cc\">/// <b>status</b> = </span><span style=\"color: blue\">'draft'</span>\r\n\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"http://hl7.org/fhir/R5/condition.html\" title=\"Condition\">http://hl7.org/fhir/StructureDefinition/Condition</a><span style=\"color: navy\">&quot; </span><b>alias </b>Condition <b>as </b><b>source</b>\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"StructureDefinition-ConditionOccurrence.html\" title=\"Condition Occurrence OMOP Table\">http://hl7.org/fhir/uv/omop/StructureDefinition/ConditionOccurrence</a><span style=\"color: navy\">&quot; </span><b>alias </b>ConOccTable <b>as </b><b>target</b>\r\n\r\n<b>group </b>ConditionOccurrence<span style=\"color: navy\">(</span><b>source</b> <span style=\"color: maroon\">src</span><span style=\"color: navy\"> : </span>Condition, <b>target</b> <span style=\"color: maroon\">tgt</span><span style=\"color: navy\"> : </span>ConOccTable<span style=\"color: navy\">)</span><span style=\"color: navy\"> {\r\n</span>  src.code<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      sc.code<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.condition_concept_id = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.id as id -&gt; tgt.condition_occurrence_id = cast(id, &quot;integer&quot;);</span>\r\n  src.recordedDate<b> as </b><span style=\"color: maroon\">rd</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.condition_start_datetime = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">rd</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'dateTime'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">, </span> tgt.condition_start_date = <span style=\"color: maroon\">rd</span><span style=\"color: navy\">;</span>\r\n  src.onset<span style=\"color: navy\"> : </span>dateTime<b> as </b><span style=\"color: maroon\">osd</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.condition_start_datetime = <span style=\"color: maroon\">osd</span><span style=\"color: navy\">, </span> tgt.condition_start_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">osd</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n  src.abatement<span style=\"color: navy\"> : </span>dateTime<b> as </b><span style=\"color: maroon\">abdt</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.condition_end_datetime = <span style=\"color: maroon\">adt</span><span style=\"color: navy\">, </span> tgt.condition_end_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">abdt</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n  src.category<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      sc.code<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.condition_type_concept_id = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  src.clinicalStatus<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      sc.code<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.condition_status_concept_id = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  src.evidence<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.concept<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      sc.coding<b> as </b><span style=\"color: maroon\">sci</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>        sci.code<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.condition_source_concept_id = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n      <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.encounter as s -&gt; tgt then {</span>\r\n<span style=\"color: navy\">}\r\n\r\n</span></pre></div>",
                            "status": "generated"
                        },
                        "group": [
                            {
                                "name": "ConditionOccurrence",
                                "rule": [
                                    {
                                        "name": "code",
                                        "rule": [
                                            {
                                                "name": "coding",
                                                "rule": [
                                                    {
                                                        "name": "code",
                                                        "source": [
                                                            {
                                                                "context": "sc",
                                                                "element": "code",
                                                                "variable": "a"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "condition_concept_id",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "a"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "coding",
                                                        "variable": "sc"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "code",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ],
                                        "documentation": "src.id as id -> tgt.condition_occurrence_id = cast(id, \"integer\");"
                                    },
                                    {
                                        "name": "recordedDate",
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "recordedDate",
                                                "variable": "rd"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "condition_start_datetime",
                                                "parameter": [
                                                    {
                                                        "valueId": "rd"
                                                    },
                                                    {
                                                        "valueString": "dateTime"
                                                    }
                                                ],
                                                "transform": "cast"
                                            },
                                            {
                                                "context": "tgt",
                                                "element": "condition_start_date",
                                                "parameter": [
                                                    {
                                                        "valueId": "rd"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "onsetDateTime",
                                        "source": [
                                            {
                                                "type": "dateTime",
                                                "context": "src",
                                                "element": "onset",
                                                "variable": "osd"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "condition_start_datetime",
                                                "parameter": [
                                                    {
                                                        "valueId": "osd"
                                                    }
                                                ],
                                                "transform": "copy"
                                            },
                                            {
                                                "context": "tgt",
                                                "element": "condition_start_date",
                                                "parameter": [
                                                    {
                                                        "valueId": "osd"
                                                    },
                                                    {
                                                        "valueString": "date"
                                                    }
                                                ],
                                                "transform": "cast"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "abatementDateTime",
                                        "source": [
                                            {
                                                "type": "dateTime",
                                                "context": "src",
                                                "element": "abatement",
                                                "variable": "abdt"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "condition_end_datetime",
                                                "parameter": [
                                                    {
                                                        "valueId": "adt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            },
                                            {
                                                "context": "tgt",
                                                "element": "condition_end_date",
                                                "parameter": [
                                                    {
                                                        "valueId": "abdt"
                                                    },
                                                    {
                                                        "valueString": "date"
                                                    }
                                                ],
                                                "transform": "cast"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "category",
                                        "rule": [
                                            {
                                                "name": "coding",
                                                "rule": [
                                                    {
                                                        "name": "code",
                                                        "source": [
                                                            {
                                                                "context": "sc",
                                                                "element": "code",
                                                                "variable": "a"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "condition_type_concept_id",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "a"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "coding",
                                                        "variable": "sc"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "category",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "clinicalStatus",
                                        "rule": [
                                            {
                                                "name": "coding",
                                                "rule": [
                                                    {
                                                        "name": "code",
                                                        "source": [
                                                            {
                                                                "context": "sc",
                                                                "element": "code",
                                                                "variable": "a"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "condition_status_concept_id",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "a"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "coding",
                                                        "variable": "sc"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "clinicalStatus",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "evidence",
                                        "rule": [
                                            {
                                                "name": "concept",
                                                "rule": [
                                                    {
                                                        "name": "coding",
                                                        "rule": [
                                                            {
                                                                "name": "code",
                                                                "source": [
                                                                    {
                                                                        "context": "sci",
                                                                        "element": "code",
                                                                        "variable": "a"
                                                                    }
                                                                ],
                                                                "target": [
                                                                    {
                                                                        "context": "tgt",
                                                                        "element": "condition_source_concept_id",
                                                                        "parameter": [
                                                                            {
                                                                                "valueId": "a"
                                                                            }
                                                                        ],
                                                                        "transform": "copy"
                                                                    }
                                                                ]
                                                            }
                                                        ],
                                                        "source": [
                                                            {
                                                                "context": "sc",
                                                                "element": "coding",
                                                                "variable": "sci"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "tgt"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "concept",
                                                        "variable": "sc"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "evidence",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ],
                                        "documentation": "src.encounter as s -> tgt then {"
                                    }
                                ],
                                "input": [
                                    {
                                        "mode": "source",
                                        "name": "src",
                                        "type": "Condition"
                                    },
                                    {
                                        "mode": "target",
                                        "name": "tgt",
                                        "type": "ConOccTable"
                                    }
                                ]
                            }
                        ],
                        "title": "Mapping Condition resource to Condition Occurrence OMOP Domain",
                        "status": "draft",
                        "contact": [
                            {
                                "name": "HL7 International / Biomedical Research and Regulation",
                                "telecom": [
                                    {
                                        "value": "http://www.hl7.org/Special/committees/rcrim",
                                        "system": "url"
                                    }
                                ]
                            }
                        ],
                        "version": "1.0.0-ballot",
                        "extension": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-wg",
                                "valueCode": "brr"
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-fmm",
                                "valueInteger": 1,
                                "_valueInteger": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-standards-status",
                                "valueCode": "informative",
                                "_valueCode": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            }
                        ],
                        "publisher": "HL7 International / Biomedical Research and Regulation",
                        "structure": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/Condition",
                                "mode": "source",
                                "alias": "Condition"
                            },
                            {
                                "url": "http://hl7.org/fhir/uv/omop/StructureDefinition/ConditionOccurrence",
                                "mode": "target",
                                "alias": "ConOccTable"
                            }
                        ],
                        "description": "This mapping maps FHIR Condition instances to OMOP Condition Occurence Table objects.",
                        "jurisdiction": [
                            {
                                "coding": [
                                    {
                                        "code": "001",
                                        "system": "http://unstats.un.org/unsd/methods/m49/m49.htm",
                                        "display": "World"
                                    }
                                ]
                            }
                        ],
                        "resourceType": "StructureMap"
                    },
                    "output_omop_data": ""
                },
                "type": "transform_data_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 150,
                    "y": 910
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 150,
                    "y": 910
                }
            },
            {
                "id": "5b177aca-870c-4745-95e1-6305ee390261",
                "data": {
                    "name": "Insert_into_omop_person",
                    "database": "alpdev_pg",
                    "dataframe": "transform_fhir_omop_patient",
                    "schemaname": "cdm_ds1_1761010593",
                    "dbtablename": "condition_occurrence",
                    "description": "Insert into omop cdm database"
                },
                "type": "db_writer_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 650,
                    "y": 890
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 650,
                    "y": 890
                }
            },
            {
                "id": "fcab0880-2901-49fb-8e3c-e73735a07030",
                "data": {
                    "name": "get_encounter_fhir_data",
                    "database": "alp_fhir",
                    "sqlquery": "select content as Encounter from \"fhir\".\"Encounter\"",
                    "testdata": [
                        []
                    ],
                    "description": "Get fhir data for Encounter resource"
                },
                "type": "db_reader_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": -360,
                    "y": 1280
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": -360,
                    "y": 1280
                }
            },
            {
                "id": "1aa813ea-bb41-4d13-bfbf-3ce1e45be964",
                "data": {
                    "id": "EncounterVisitMap",
                    "name": "transform_fhir_omop_visit_occurrence",
                    "error": true,
                    "result": "{\n  \"error\": true,\n  \"errorMessage\": \"Traceback (most recent call last):\\n  File \\\"/app/flows/dataflow_ui_plugin/nodes.py\\\", line 443, in task\\n    raise Exception(\\\"Transformation resulted in empty dataframe\\\")\\nException: Transformation resulted in empty dataframe\\n\",\n  \"nodeName\": \"transform_fhir_omop_visit_occurrence\"\n}",
                    "dataframe": "get_encounter_fhir_data",
                    "description": "Transform condition fhir resource to visit_occurrence omop table",
                    "errorMessage": "Traceback (most recent call last):\n  File \"/app/flows/dataflow_ui_plugin/nodes.py\", line 443, in task\n    raise Exception(\"Transformation resulted in empty dataframe\")\nException: Transformation resulted in empty dataframe\n",
                    "structure_map": {
                        "id": "EncounterVisitMap",
                        "url": "http://hl7.org/fhir/uv/omop/StructureMap/EncounterVisitMap",
                        "date": "2025-07-29T17:40:15+00:00",
                        "name": "EncounterVisitMap",
                        "text": {
                            "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><p class=\"res-header-id\"><b>Generated Narrative: StructureMap EncounterVisitMap</b></p><a name=\"EncounterVisitMap\"> </a><a name=\"hcEncounterVisitMap\"> </a><pre class=\"fml\">\r\n<span style=\"color: #cc00cc\">/// <b>url</b> = </span><span style=\"color: blue\">'http://hl7.org/fhir/uv/omop/StructureMap/EncounterVisitMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>name</b> = </span><span style=\"color: blue\">'EncounterVisitMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>title</b> = </span><span style=\"color: blue\">'Mapping Encounter resource to VisitOccurrence OMOP Domain'</span>\r\n<span style=\"color: #cc00cc\">/// <b>status</b> = </span><span style=\"color: blue\">'draft'</span>\r\n\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"http://hl7.org/fhir/R5/encounter.html\" title=\"Encounter\">http://hl7.org/fhir/StructureDefinition/Encounter</a><span style=\"color: navy\">&quot; </span><b>alias </b>Encounter <b>as </b><b>source</b>\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"StructureDefinition-VisitOccurrence.html\" title=\"Visit Occurrence OMOP Table\">http://hl7.org/fhir/uv/omop/StructureDefinition/VisitOccurrence</a><span style=\"color: navy\">&quot; </span><b>alias </b>VisitTable <b>as </b><b>target</b>\r\n\r\n<b>group </b>VisitOccurrence<span style=\"color: navy\">(</span><b>source</b> <span style=\"color: maroon\">src</span><span style=\"color: navy\"> : </span>Encounter, <b>target</b> <span style=\"color: maroon\">tgt</span><span style=\"color: navy\"> : </span>VisitTable<span style=\"color: navy\">)</span><span style=\"color: navy\"> {\r\n</span>  src.class<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      sc.code<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.visit_concept_id = <span style=\"color: maroon\">a</span><span style=\"color: navy\">, </span> tgt.visit_source_value = <span style=\"color: maroon\">a</span><span style=\"color: navy\">, </span> tgt.visit_source_concept_id = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.id as id -&gt; tgt.visit_occurrence_id = cast(id, &quot;integer&quot;);</span>\r\n  src.actualPeriod<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.start<b> as </b><span style=\"color: maroon\">std</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.visit_start_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">std</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">, </span> tgt.visit_start_datetime = <span style=\"color: maroon\">std</span><span style=\"color: navy\">;</span>\r\n    s.end<b> as </b><span style=\"color: maroon\">ed</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.visit_end_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">ed</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">, </span> tgt.visit_end_datetime = <span style=\"color: maroon\">ed</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  src.admission<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.admitSource<b> as </b><span style=\"color: maroon\">sa</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      sa.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>        sc.code<b> as </b><span style=\"color: maroon\">code</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.admitted_from_concept_id = <span style=\"color: maroon\">code</span><span style=\"color: navy\">, </span> tgt.admitted_from_source_value = <span style=\"color: maroon\">code</span><span style=\"color: navy\">;</span>\r\n      <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    s.dischargeDisposition<b> as </b><span style=\"color: maroon\">sd</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      sd.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>        sc.code<b> as </b><span style=\"color: maroon\">code</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.discharged_to_concept_id = <span style=\"color: maroon\">code</span><span style=\"color: navy\">, </span> tgt.discharged_to_source_value = <span style=\"color: maroon\">code</span><span style=\"color: navy\">;</span>\r\n      <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n<span style=\"color: navy\">}\r\n\r\n</span></pre></div>",
                            "status": "generated"
                        },
                        "group": [
                            {
                                "name": "VisitOccurrence",
                                "rule": [
                                    {
                                        "name": "class",
                                        "rule": [
                                            {
                                                "name": "coding",
                                                "rule": [
                                                    {
                                                        "name": "code",
                                                        "source": [
                                                            {
                                                                "context": "sc",
                                                                "element": "code",
                                                                "variable": "a"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "visit_concept_id",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "a"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            },
                                                            {
                                                                "context": "tgt",
                                                                "element": "visit_source_value",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "a"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            },
                                                            {
                                                                "context": "tgt",
                                                                "element": "visit_source_concept_id",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "a"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "coding",
                                                        "variable": "sc"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "class",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ],
                                        "documentation": "src.id as id -> tgt.visit_occurrence_id = cast(id, \"integer\");"
                                    },
                                    {
                                        "name": "actualPeriod",
                                        "rule": [
                                            {
                                                "name": "start",
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "start",
                                                        "variable": "std"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "visit_start_date",
                                                        "parameter": [
                                                            {
                                                                "valueId": "std"
                                                            },
                                                            {
                                                                "valueString": "date"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    },
                                                    {
                                                        "context": "tgt",
                                                        "element": "visit_start_datetime",
                                                        "parameter": [
                                                            {
                                                                "valueId": "std"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "end",
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "end",
                                                        "variable": "ed"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "visit_end_date",
                                                        "parameter": [
                                                            {
                                                                "valueId": "ed"
                                                            },
                                                            {
                                                                "valueString": "date"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    },
                                                    {
                                                        "context": "tgt",
                                                        "element": "visit_end_datetime",
                                                        "parameter": [
                                                            {
                                                                "valueId": "ed"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "actualPeriod",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "admission",
                                        "rule": [
                                            {
                                                "name": "admitSource",
                                                "rule": [
                                                    {
                                                        "name": "coding",
                                                        "rule": [
                                                            {
                                                                "name": "code",
                                                                "source": [
                                                                    {
                                                                        "context": "sc",
                                                                        "element": "code",
                                                                        "variable": "code"
                                                                    }
                                                                ],
                                                                "target": [
                                                                    {
                                                                        "context": "tgt",
                                                                        "element": "admitted_from_concept_id",
                                                                        "parameter": [
                                                                            {
                                                                                "valueId": "code"
                                                                            }
                                                                        ],
                                                                        "transform": "copy"
                                                                    },
                                                                    {
                                                                        "context": "tgt",
                                                                        "element": "admitted_from_source_value",
                                                                        "parameter": [
                                                                            {
                                                                                "valueId": "code"
                                                                            }
                                                                        ],
                                                                        "transform": "copy"
                                                                    }
                                                                ]
                                                            }
                                                        ],
                                                        "source": [
                                                            {
                                                                "context": "sa",
                                                                "element": "coding",
                                                                "variable": "sc"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "tgt"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "admitSource",
                                                        "variable": "sa"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "dischargeDisposition",
                                                "rule": [
                                                    {
                                                        "name": "coding",
                                                        "rule": [
                                                            {
                                                                "name": "code",
                                                                "source": [
                                                                    {
                                                                        "context": "sc",
                                                                        "element": "code",
                                                                        "variable": "code"
                                                                    }
                                                                ],
                                                                "target": [
                                                                    {
                                                                        "context": "tgt",
                                                                        "element": "discharged_to_concept_id",
                                                                        "parameter": [
                                                                            {
                                                                                "valueId": "code"
                                                                            }
                                                                        ],
                                                                        "transform": "copy"
                                                                    },
                                                                    {
                                                                        "context": "tgt",
                                                                        "element": "discharged_to_source_value",
                                                                        "parameter": [
                                                                            {
                                                                                "valueId": "code"
                                                                            }
                                                                        ],
                                                                        "transform": "copy"
                                                                    }
                                                                ]
                                                            }
                                                        ],
                                                        "source": [
                                                            {
                                                                "context": "sd",
                                                                "element": "coding",
                                                                "variable": "sc"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "tgt"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "dischargeDisposition",
                                                        "variable": "sd"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "admission",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    }
                                ],
                                "input": [
                                    {
                                        "mode": "source",
                                        "name": "src",
                                        "type": "Encounter"
                                    },
                                    {
                                        "mode": "target",
                                        "name": "tgt",
                                        "type": "VisitTable"
                                    }
                                ]
                            }
                        ],
                        "title": "Mapping Encounter resource to VisitOccurrence OMOP Domain",
                        "status": "draft",
                        "contact": [
                            {
                                "name": "HL7 International / Biomedical Research and Regulation",
                                "telecom": [
                                    {
                                        "value": "http://www.hl7.org/Special/committees/rcrim",
                                        "system": "url"
                                    }
                                ]
                            }
                        ],
                        "version": "1.0.0-ballot",
                        "extension": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-wg",
                                "valueCode": "brr"
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-fmm",
                                "valueInteger": 1,
                                "_valueInteger": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-standards-status",
                                "valueCode": "informative",
                                "_valueCode": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            }
                        ],
                        "publisher": "HL7 International / Biomedical Research and Regulation",
                        "structure": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/Encounter",
                                "mode": "source",
                                "alias": "Encounter"
                            },
                            {
                                "url": "http://hl7.org/fhir/uv/omop/StructureDefinition/VisitOccurrence",
                                "mode": "target",
                                "alias": "VisitTable"
                            }
                        ],
                        "description": "This mapping maps FHIR Encounter instances to OMOP Visit Occurence Table objects.",
                        "jurisdiction": [
                            {
                                "coding": [
                                    {
                                        "code": "001",
                                        "system": "http://unstats.un.org/unsd/methods/m49/m49.htm",
                                        "display": "World"
                                    }
                                ]
                            }
                        ],
                        "resourceType": "StructureMap"
                    },
                    "output_omop_data": ""
                },
                "type": "transform_data_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 190,
                    "y": 1240
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 190,
                    "y": 1240
                }
            },
            {
                "id": "c59e95aa-1642-4f04-a07d-c19a496aca91",
                "data": {
                    "name": "Insert_into_omop_visit_occurrence",
                    "error": true,
                    "result": "{\n  \"error\": true,\n  \"errorMessage\": \"Traceback (most recent call last):\\n  File \\\"/app/flows/dataflow_ui_plugin/nodes.py\\\", line 468, in task\\n    result = df_to_write.to_sql(self.table_name,\\n            ^^^^^^^^^^^^^^^^^^\\nAttributeError: 'str' object has no attribute 'to_sql'\\n\",\n  \"nodeName\": \"Insert_into_omop_visit_occurrence\"\n}",
                    "database": "alpdev_pg",
                    "dataframe": "transform_fhir_omop_visit_occurrence",
                    "schemaname": "cdm_ds1_1761010593",
                    "dbtablename": "visit_occurrence",
                    "description": "Insert into omop cdm database",
                    "errorMessage": "Traceback (most recent call last):\n  File \"/app/flows/dataflow_ui_plugin/nodes.py\", line 468, in task\n    result = df_to_write.to_sql(self.table_name,\n            ^^^^^^^^^^^^^^^^^^\nAttributeError: 'str' object has no attribute 'to_sql'\n"
                },
                "type": "db_writer_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 720,
                    "y": 1250
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 720,
                    "y": 1250
                }
            },
            {
                "id": "97d2d719-131e-4e91-9965-5dacc4f77bba",
                "data": {
                    "name": "get_immunization_fhir_data",
                    "error": false,
                    "result": "{\n  \"error\": false,\n  \"errorMessage\": null,\n  \"nodeName\": \"get_immunization_fhir_data\",\n  \"length\": 1,\n  \"type\": \"<class 'pandas.core.frame.DataFrame'>\",\n  \"schema\": {\n    \"content\": \"object\"\n  }\n}",
                    "database": "alp_fhir",
                    "sqlquery": "select content from \"fhir\".\"Immunization\"",
                    "testdata": [
                        []
                    ],
                    "description": "Get fhir data for Immunization resource",
                    "errorMessage": null
                },
                "type": "db_reader_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": -330,
                    "y": 1660
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": -330,
                    "y": 1660
                }
            },
            {
                "id": "e9547ad0-a803-407e-82e6-c8f5f474b9b2",
                "data": {
                    "id": "ImmunizationMap",
                    "name": "transform_fhir_omop_drug_exposure",
                    "error": true,
                    "result": "{\n  \"error\": true,\n  \"errorMessage\": \"Traceback (most recent call last):\\n  File \\\"/app/flows/dataflow_ui_plugin/nodes.py\\\", line 441, in task\\n    df = self.transform_data(df_to_write)\\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/flows/dataflow_ui_plugin/nodes.py\\\", line 419, in transform_data\\n    raise Exception(f\\\"FHIR Transform failed with error: {stdout}\\\")\\nException: FHIR Transform failed with error: Transform failed: Error: \\\"CodeableReference\\\" cannot be resolved to a valid type identifier\\n{\\\"error\\\":true}\\n\",\n  \"nodeName\": \"transform_fhir_omop_drug_exposure\"\n}",
                    "dataframe": "get_immunization_fhir_data",
                    "description": "Transform condition fhir resource to drug_exposure omop table",
                    "errorMessage": "Traceback (most recent call last):\n  File \"/app/flows/dataflow_ui_plugin/nodes.py\", line 441, in task\n    df = self.transform_data(df_to_write)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/flows/dataflow_ui_plugin/nodes.py\", line 419, in transform_data\n    raise Exception(f\"FHIR Transform failed with error: {stdout}\")\nException: FHIR Transform failed with error: Transform failed: Error: \"CodeableReference\" cannot be resolved to a valid type identifier\n{\"error\":true}\n",
                    "structure_map": {
                        "id": "ImmunizationMap",
                        "url": "http://hl7.org/fhir/uv/omop/StructureMap/ImmunizationMap",
                        "date": "2025-07-29T17:40:15+00:00",
                        "name": "ImmunizationMap",
                        "text": {
                            "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><p class=\"res-header-id\"><b>Generated Narrative: StructureMap ImmunizationMap</b></p><a name=\"ImmunizationMap\"> </a><a name=\"hcImmunizationMap\"> </a><pre class=\"fml\">\r\n<span style=\"color: #cc00cc\">/// <b>url</b> = </span><span style=\"color: blue\">'http://hl7.org/fhir/uv/omop/StructureMap/ImmunizationMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>name</b> = </span><span style=\"color: blue\">'ImmunizationMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>title</b> = </span><span style=\"color: blue\">'Mapping Immunization resource to Drug Exposure OMOP Domain'</span>\r\n<span style=\"color: #cc00cc\">/// <b>status</b> = </span><span style=\"color: blue\">'draft'</span>\r\n\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"http://hl7.org/fhir/R5/immunization.html\" title=\"Immunization\">http://hl7.org/fhir/StructureDefinition/Immunization</a><span style=\"color: navy\">&quot; </span><b>alias </b>Immunization <b>as </b><b>source</b>\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"StructureDefinition-DrugExposure.html\" title=\"Drug Exposure OMOP Table\">http://hl7.org/fhir/uv/omop/StructureDefinition/DrugExposure</a><span style=\"color: navy\">&quot; </span><b>alias </b>DrugExposureTable <b>as </b><b>target</b>\r\n\r\n<b>group </b>DrugExposure<span style=\"color: navy\">(</span><b>source</b> <span style=\"color: maroon\">src</span><span style=\"color: navy\"> : </span>Immunization, <b>target</b> <span style=\"color: maroon\">tgt</span><span style=\"color: navy\"> : </span>DrugExposureTable<span style=\"color: navy\">)</span><span style=\"color: navy\"> {\r\n</span>  src.vaccineCode<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      sc.code<span style=\"color: navy\"><b> -&gt; </b></span> tgt.drug_concept_id<span style=\"color: navy\">, </span> tgt.drug_source_value<span style=\"color: navy\">, </span> tgt.drug_source_concept_id<span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.id as id -&gt; tgt.drug_exposure_id = cast(id, &quot;integer&quot;);</span>\r\n  src.doseQuantity<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.value<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.quantity = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">s</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'decimal'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n    s.code<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.dose_unit_source_value = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">s</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'string'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.patient as s -&gt; tgt then {</span>\r\n  src.route<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.text<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.route_source_value = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">s</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'string'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n    s.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      sc.code<span style=\"color: navy\"><b> -&gt; </b></span> tgt.route_concept_id<span style=\"color: navy\">, </span> tgt.route_source_value<span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  src.occurrence<span style=\"color: navy\"> : </span>dateTime<b> as </b><span style=\"color: maroon\">odt</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.drug_exposure_start_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">odt</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">, </span> tgt.drug_exposure_start_datetime = <span style=\"color: maroon\">odt</span><span style=\"color: navy\">, </span> tgt.drug_exposure_end_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">odt</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">, </span> tgt.drug_exposure_end_datetime = <span style=\"color: maroon\">odt</span><span style=\"color: navy\">;</span>\r\n  src.lotNumber<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.lot_number = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">s</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'string'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.encounter as s -&gt; tgt then {</span>\r\n<span style=\"color: navy\">}\r\n\r\n</span></pre></div>",
                            "status": "generated"
                        },
                        "group": [
                            {
                                "name": "DrugExposure",
                                "rule": [
                                    {
                                        "name": "vaccineCode",
                                        "rule": [
                                            {
                                                "name": "coding",
                                                "rule": [
                                                    {
                                                        "name": "code",
                                                        "source": [
                                                            {
                                                                "context": "sc",
                                                                "element": "code"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "drug_concept_id"
                                                            },
                                                            {
                                                                "context": "tgt",
                                                                "element": "drug_source_value"
                                                            },
                                                            {
                                                                "context": "tgt",
                                                                "element": "drug_source_concept_id"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "coding",
                                                        "variable": "sc"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "vaccineCode",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ],
                                        "documentation": "src.id as id -> tgt.drug_exposure_id = cast(id, \"integer\");"
                                    },
                                    {
                                        "name": "doseQuantity",
                                        "rule": [
                                            {
                                                "name": "value",
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "value",
                                                        "variable": "s"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "quantity",
                                                        "parameter": [
                                                            {
                                                                "valueId": "s"
                                                            },
                                                            {
                                                                "valueString": "decimal"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "code",
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "code",
                                                        "variable": "s"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "dose_unit_source_value",
                                                        "parameter": [
                                                            {
                                                                "valueId": "s"
                                                            },
                                                            {
                                                                "valueString": "string"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "doseQuantity",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ],
                                        "documentation": "src.patient as s -> tgt then {"
                                    },
                                    {
                                        "name": "route",
                                        "rule": [
                                            {
                                                "name": "text",
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "text",
                                                        "variable": "s"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "route_source_value",
                                                        "parameter": [
                                                            {
                                                                "valueId": "s"
                                                            },
                                                            {
                                                                "valueString": "string"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "coding",
                                                "rule": [
                                                    {
                                                        "name": "code",
                                                        "source": [
                                                            {
                                                                "context": "sc",
                                                                "element": "code"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "route_concept_id"
                                                            },
                                                            {
                                                                "context": "tgt",
                                                                "element": "route_source_value"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "coding",
                                                        "variable": "sc"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "route",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "occurrenceDateTime",
                                        "source": [
                                            {
                                                "type": "dateTime",
                                                "context": "src",
                                                "element": "occurrence",
                                                "variable": "odt"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "drug_exposure_start_date",
                                                "parameter": [
                                                    {
                                                        "valueId": "odt"
                                                    },
                                                    {
                                                        "valueString": "date"
                                                    }
                                                ],
                                                "transform": "cast"
                                            },
                                            {
                                                "context": "tgt",
                                                "element": "drug_exposure_start_datetime",
                                                "parameter": [
                                                    {
                                                        "valueId": "odt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            },
                                            {
                                                "context": "tgt",
                                                "element": "drug_exposure_end_date",
                                                "parameter": [
                                                    {
                                                        "valueId": "odt"
                                                    },
                                                    {
                                                        "valueString": "date"
                                                    }
                                                ],
                                                "transform": "cast"
                                            },
                                            {
                                                "context": "tgt",
                                                "element": "drug_exposure_end_datetime",
                                                "parameter": [
                                                    {
                                                        "valueId": "odt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "lotNumber",
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "lotNumber",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "lot_number",
                                                "parameter": [
                                                    {
                                                        "valueId": "s"
                                                    },
                                                    {
                                                        "valueString": "string"
                                                    }
                                                ],
                                                "transform": "cast"
                                            }
                                        ],
                                        "documentation": "src.encounter as s -> tgt then {"
                                    }
                                ],
                                "input": [
                                    {
                                        "mode": "source",
                                        "name": "src",
                                        "type": "Immunization"
                                    },
                                    {
                                        "mode": "target",
                                        "name": "tgt",
                                        "type": "DrugExposureTable"
                                    }
                                ]
                            }
                        ],
                        "title": "Mapping Immunization resource to Drug Exposure OMOP Domain",
                        "status": "draft",
                        "contact": [
                            {
                                "name": "HL7 International / Biomedical Research and Regulation",
                                "telecom": [
                                    {
                                        "value": "http://www.hl7.org/Special/committees/rcrim",
                                        "system": "url"
                                    }
                                ]
                            }
                        ],
                        "version": "1.0.0-ballot",
                        "extension": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-wg",
                                "valueCode": "brr"
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-fmm",
                                "valueInteger": 1,
                                "_valueInteger": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-standards-status",
                                "valueCode": "informative",
                                "_valueCode": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            }
                        ],
                        "publisher": "HL7 International / Biomedical Research and Regulation",
                        "structure": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/Immunization",
                                "mode": "source",
                                "alias": "Immunization"
                            },
                            {
                                "url": "http://hl7.org/fhir/uv/omop/StructureDefinition/DrugExposure",
                                "mode": "target",
                                "alias": "DrugExposureTable"
                            }
                        ],
                        "description": "This mapping maps FHIR Immunization instances to OMOP Drug Exposure Table objects.",
                        "jurisdiction": [
                            {
                                "coding": [
                                    {
                                        "code": "001",
                                        "system": "http://unstats.un.org/unsd/methods/m49/m49.htm",
                                        "display": "World"
                                    }
                                ]
                            }
                        ],
                        "resourceType": "StructureMap"
                    },
                    "output_omop_data": ""
                },
                "type": "transform_data_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 190,
                    "y": 1640
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 190,
                    "y": 1640
                }
            },
            {
                "id": "b3e0cbd2-1680-4d5a-8a58-a74d636f1696",
                "data": {
                    "name": "Insert_into_omop_drug_exposure",
                    "error": true,
                    "result": "{\n  \"error\": true,\n  \"errorMessage\": \"Traceback (most recent call last):\\n  File \\\"/app/flows/dataflow_ui_plugin/nodes.py\\\", line 468, in task\\n    result = df_to_write.to_sql(self.table_name,\\n            ^^^^^^^^^^^^^^^^^^\\nAttributeError: 'str' object has no attribute 'to_sql'\\n\",\n  \"nodeName\": \"Insert_into_omop_drug_exposure\"\n}",
                    "database": "alpdev_pg",
                    "dataframe": "transform_fhir_omop_drug_exposure",
                    "schemaname": "cdm_ds1_1761010593",
                    "dbtablename": "drug_exposure",
                    "description": "Insert into omop cdm database",
                    "errorMessage": "Traceback (most recent call last):\n  File \"/app/flows/dataflow_ui_plugin/nodes.py\", line 468, in task\n    result = df_to_write.to_sql(self.table_name,\n            ^^^^^^^^^^^^^^^^^^\nAttributeError: 'str' object has no attribute 'to_sql'\n"
                },
                "type": "db_writer_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 740,
                    "y": 1640
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 740,
                    "y": 1640
                }
            },
            {
                "id": "644c6dc1-72bf-4f5b-8a64-620407a36e3a",
                "data": {
                    "name": "get_observation_fhir_data",
                    "error": false,
                    "result": "{\n  \"error\": false,\n  \"errorMessage\": null,\n  \"nodeName\": \"get_observation_fhir_data\",\n  \"length\": 1,\n  \"type\": \"<class 'pandas.core.frame.DataFrame'>\",\n  \"schema\": {\n    \"content\": \"object\"\n  }\n}",
                    "database": "alp_fhir",
                    "sqlquery": "select content from \"fhir\".\"Observation\"",
                    "testdata": [
                        []
                    ],
                    "description": "Get fhir data for Observation resource",
                    "errorMessage": null
                },
                "type": "db_reader_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": -330,
                    "y": 2030
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": -330,
                    "y": 2030
                }
            },
            {
                "id": "6fbd33f7-bad1-43ab-85db-f2e8a2e07883",
                "data": {
                    "id": "MeasurementMap",
                    "name": "transform_fhir_omop_measurement",
                    "error": true,
                    "result": "{\n  \"error\": true,\n  \"errorMessage\": \"Traceback (most recent call last):\\n  File \\\"/app/flows/dataflow_ui_plugin/nodes.py\\\", line 441, in task\\n    df = self.transform_data(df_to_write)\\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/flows/dataflow_ui_plugin/nodes.py\\\", line 419, in transform_data\\n    raise Exception(f\\\"FHIR Transform failed with error: {stdout}\\\")\\nException: FHIR Transform failed with error: Transform failed: Error: The 'cast' transform function is not yet supported.\\n{\\\"error\\\":true}\\n\",\n  \"nodeName\": \"transform_fhir_omop_measurement\"\n}",
                    "dataframe": "get_observation_fhir_data",
                    "description": "Transform condition fhir resource to measurement omop table",
                    "errorMessage": "Traceback (most recent call last):\n  File \"/app/flows/dataflow_ui_plugin/nodes.py\", line 441, in task\n    df = self.transform_data(df_to_write)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/flows/dataflow_ui_plugin/nodes.py\", line 419, in transform_data\n    raise Exception(f\"FHIR Transform failed with error: {stdout}\")\nException: FHIR Transform failed with error: Transform failed: Error: The 'cast' transform function is not yet supported.\n{\"error\":true}\n",
                    "structure_map": {
                        "id": "MeasurementMap",
                        "url": "http://hl7.org/fhir/uv/omop/StructureMap/MeasurementMap",
                        "date": "2025-07-29T17:40:15+00:00",
                        "name": "MeasurementMap",
                        "text": {
                            "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><p class=\"res-header-id\"><b>Generated Narrative: StructureMap MeasurementMap</b></p><a name=\"MeasurementMap\"> </a><a name=\"hcMeasurementMap\"> </a><pre class=\"fml\">\r\n<span style=\"color: #cc00cc\">/// <b>url</b> = </span><span style=\"color: blue\">'http://hl7.org/fhir/uv/omop/StructureMap/MeasurementMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>name</b> = </span><span style=\"color: blue\">'MeasurementMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>title</b> = </span><span style=\"color: blue\">'Mapping Observation resource to Measurement  OMOP Domain'</span>\r\n<span style=\"color: #cc00cc\">/// <b>status</b> = </span><span style=\"color: blue\">'draft'</span>\r\n\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"http://hl7.org/fhir/R5/observation.html\" title=\"Observation\">http://hl7.org/fhir/StructureDefinition/Observation</a><span style=\"color: navy\">&quot; </span><b>alias </b>Observation <b>as </b><b>source</b>\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"StructureDefinition-Measurement.html\" title=\"Measurement OMOP Table\">http://hl7.org/fhir/uv/omop/StructureDefinition/Measurement</a><span style=\"color: navy\">&quot; </span><b>alias </b>MeasureTable <b>as </b><b>target</b>\r\n\r\n<b>group </b>Measures<span style=\"color: navy\">(</span><b>source</b> <span style=\"color: maroon\">src</span><span style=\"color: navy\"> : </span>Observation, <b>target</b> <span style=\"color: maroon\">tgt</span><span style=\"color: navy\"> : </span>MeasureTable<span style=\"color: navy\">)</span><span style=\"color: navy\"> {\r\n</span>  src<b> where </b>('vital-signs' | 'laboratory').supersetOf(Observation.category.coding.code)<b> then</b><span style=\"color: navy\"> {\r\n</span>    src.code<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      s.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>        sc.code<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.measurement_concept_id = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n      <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.id as id -&gt; tgt.measurement_id = cast(id, &quot;integer&quot;);</span>\r\n    src.effective<span style=\"color: navy\"> : </span>dateTime<b> as </b><span style=\"color: maroon\">edt</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.measurement_datetime = <span style=\"color: maroon\">edt</span><span style=\"color: navy\">, </span> tgt.measurement_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">edt</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.subject as s -&gt; tgt then {</span>\r\n    src.effective<span style=\"color: navy\"> : </span>instant<b> as </b><span style=\"color: maroon\">einst</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.measurement_datetime = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">einst</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'dateTime'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">, </span> tgt.measurement_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">einst</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n    src.effective<span style=\"color: navy\"> : </span>Period<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      s.start<b> as </b><span style=\"color: maroon\">eps</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.measurement_datetime = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">eps</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'dateTime'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">, </span> tgt.measurement_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">eps</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    src.issued<b> as </b><span style=\"color: maroon\">s</span><b> where </b>(src.issued.toDate != src.effectiveDateTime)<span style=\"color: navy\"><b> -&gt; </b></span>tgt.measurement_source_value = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">s</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'string'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n    src.value<span style=\"color: navy\"> : </span>Quantity<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      s.value<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.value_as_number = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n      s.unit<b> as </b><span style=\"color: maroon\">b</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.unit_concept_id = <span style=\"color: maroon\">b</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.performer as s -&gt; tgt then {</span>\r\n    src.value<span style=\"color: navy\"> : </span>CodeableConcept<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      s.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>        sc.code<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.value_as_concept_id = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n      <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    src.value<span style=\"color: navy\"> : </span>string<b> as </b><span style=\"color: maroon\">b</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.value_source_value = <span style=\"color: maroon\">b</span><span style=\"color: navy\">;</span>\r\n    src.interpretation<b> as </b><span style=\"color: maroon\">c</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.value_as_concept_id = <span style=\"color: maroon\">c</span><span style=\"color: navy\">;</span>\r\n    src.note<b> as </b><span style=\"color: maroon\">d</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.measurement_source_value = <span style=\"color: maroon\">d</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span> <i>&quot;OnlyMeasures&quot;</i><span style=\"color: navy\">;</span>\r\n<span style=\"color: navy\">}\r\n\r\n</span></pre></div>",
                            "status": "generated"
                        },
                        "group": [
                            {
                                "name": "Measures",
                                "rule": [
                                    {
                                        "name": "OnlyMeasures",
                                        "rule": [
                                            {
                                                "name": "code",
                                                "rule": [
                                                    {
                                                        "name": "coding",
                                                        "rule": [
                                                            {
                                                                "name": "code",
                                                                "source": [
                                                                    {
                                                                        "context": "sc",
                                                                        "element": "code",
                                                                        "variable": "a"
                                                                    }
                                                                ],
                                                                "target": [
                                                                    {
                                                                        "context": "tgt",
                                                                        "element": "measurement_concept_id",
                                                                        "parameter": [
                                                                            {
                                                                                "valueId": "a"
                                                                            }
                                                                        ],
                                                                        "transform": "copy"
                                                                    }
                                                                ]
                                                            }
                                                        ],
                                                        "source": [
                                                            {
                                                                "context": "s",
                                                                "element": "coding",
                                                                "variable": "sc"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "tgt"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "src",
                                                        "element": "code",
                                                        "variable": "s"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ],
                                                "documentation": "src.id as id -> tgt.measurement_id = cast(id, \"integer\");"
                                            },
                                            {
                                                "name": "effectiveDateTime",
                                                "source": [
                                                    {
                                                        "type": "dateTime",
                                                        "context": "src",
                                                        "element": "effective",
                                                        "variable": "edt"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "measurement_datetime",
                                                        "parameter": [
                                                            {
                                                                "valueId": "edt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    },
                                                    {
                                                        "context": "tgt",
                                                        "element": "measurement_date",
                                                        "parameter": [
                                                            {
                                                                "valueId": "edt"
                                                            },
                                                            {
                                                                "valueString": "date"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    }
                                                ],
                                                "documentation": "src.subject as s -> tgt then {"
                                            },
                                            {
                                                "name": "effectiveInstant",
                                                "source": [
                                                    {
                                                        "type": "instant",
                                                        "context": "src",
                                                        "element": "effective",
                                                        "variable": "einst"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "measurement_datetime",
                                                        "parameter": [
                                                            {
                                                                "valueId": "einst"
                                                            },
                                                            {
                                                                "valueString": "dateTime"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    },
                                                    {
                                                        "context": "tgt",
                                                        "element": "measurement_date",
                                                        "parameter": [
                                                            {
                                                                "valueId": "einst"
                                                            },
                                                            {
                                                                "valueString": "date"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "effectivePeriod",
                                                "rule": [
                                                    {
                                                        "name": "start",
                                                        "source": [
                                                            {
                                                                "context": "s",
                                                                "element": "start",
                                                                "variable": "eps"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "measurement_datetime",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "eps"
                                                                    },
                                                                    {
                                                                        "valueString": "dateTime"
                                                                    }
                                                                ],
                                                                "transform": "cast"
                                                            },
                                                            {
                                                                "context": "tgt",
                                                                "element": "measurement_date",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "eps"
                                                                    },
                                                                    {
                                                                        "valueString": "date"
                                                                    }
                                                                ],
                                                                "transform": "cast"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "type": "Period",
                                                        "context": "src",
                                                        "element": "effective",
                                                        "variable": "s"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "issued",
                                                "source": [
                                                    {
                                                        "context": "src",
                                                        "element": "issued",
                                                        "variable": "s",
                                                        "condition": "(src.issued.toDate != src.effectiveDateTime)"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "measurement_source_value",
                                                        "parameter": [
                                                            {
                                                                "valueId": "s"
                                                            },
                                                            {
                                                                "valueString": "string"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "valueQuantity",
                                                "rule": [
                                                    {
                                                        "name": "value",
                                                        "source": [
                                                            {
                                                                "context": "s",
                                                                "element": "value",
                                                                "variable": "a"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "value_as_number",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "a"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    },
                                                    {
                                                        "name": "unit",
                                                        "source": [
                                                            {
                                                                "context": "s",
                                                                "element": "unit",
                                                                "variable": "b"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "unit_concept_id",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "b"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "type": "Quantity",
                                                        "context": "src",
                                                        "element": "value",
                                                        "variable": "s"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ],
                                                "documentation": "src.performer as s -> tgt then {"
                                            },
                                            {
                                                "name": "valueCodeableConcept",
                                                "rule": [
                                                    {
                                                        "name": "coding",
                                                        "rule": [
                                                            {
                                                                "name": "code",
                                                                "source": [
                                                                    {
                                                                        "context": "sc",
                                                                        "element": "code",
                                                                        "variable": "a"
                                                                    }
                                                                ],
                                                                "target": [
                                                                    {
                                                                        "context": "tgt",
                                                                        "element": "value_as_concept_id",
                                                                        "parameter": [
                                                                            {
                                                                                "valueId": "a"
                                                                            }
                                                                        ],
                                                                        "transform": "copy"
                                                                    }
                                                                ]
                                                            }
                                                        ],
                                                        "source": [
                                                            {
                                                                "context": "s",
                                                                "element": "coding",
                                                                "variable": "sc"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "tgt"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "type": "CodeableConcept",
                                                        "context": "src",
                                                        "element": "value",
                                                        "variable": "s"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "valueString",
                                                "source": [
                                                    {
                                                        "type": "string",
                                                        "context": "src",
                                                        "element": "value",
                                                        "variable": "b"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "value_source_value",
                                                        "parameter": [
                                                            {
                                                                "valueId": "b"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "interpretation",
                                                "source": [
                                                    {
                                                        "context": "src",
                                                        "element": "interpretation",
                                                        "variable": "c"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "value_as_concept_id",
                                                        "parameter": [
                                                            {
                                                                "valueId": "c"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "note",
                                                "source": [
                                                    {
                                                        "context": "src",
                                                        "element": "note",
                                                        "variable": "d"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "measurement_source_value",
                                                        "parameter": [
                                                            {
                                                                "valueId": "d"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "context": "src",
                                                "condition": "('vital-signs' | 'laboratory').supersetOf(Observation.category.coding.code)"
                                            }
                                        ]
                                    }
                                ],
                                "input": [
                                    {
                                        "mode": "source",
                                        "name": "src",
                                        "type": "Observation"
                                    },
                                    {
                                        "mode": "target",
                                        "name": "tgt",
                                        "type": "MeasureTable"
                                    }
                                ]
                            }
                        ],
                        "title": "Mapping Observation resource to Measurement  OMOP Domain",
                        "status": "draft",
                        "contact": [
                            {
                                "name": "HL7 International / Biomedical Research and Regulation",
                                "telecom": [
                                    {
                                        "value": "http://www.hl7.org/Special/committees/rcrim",
                                        "system": "url"
                                    }
                                ]
                            }
                        ],
                        "version": "1.0.0-ballot",
                        "extension": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-wg",
                                "valueCode": "brr"
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-fmm",
                                "valueInteger": 1,
                                "_valueInteger": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-standards-status",
                                "valueCode": "informative",
                                "_valueCode": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            }
                        ],
                        "publisher": "HL7 International / Biomedical Research and Regulation",
                        "structure": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/Observation",
                                "mode": "source",
                                "alias": "Observation"
                            },
                            {
                                "url": "http://hl7.org/fhir/uv/omop/StructureDefinition/Measurement",
                                "mode": "target",
                                "alias": "MeasureTable"
                            }
                        ],
                        "description": "This mapping maps FHIR Observation instances that are considered measurements to OMOP Measurement Table objects.  Currently, this is done by considering the category code and mapping 'vital-signs' and 'laboratory' Observations.",
                        "jurisdiction": [
                            {
                                "coding": [
                                    {
                                        "code": "001",
                                        "system": "http://unstats.un.org/unsd/methods/m49/m49.htm",
                                        "display": "World"
                                    }
                                ]
                            }
                        ],
                        "resourceType": "StructureMap"
                    },
                    "output_omop_data": ""
                },
                "type": "transform_data_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 190,
                    "y": 2020
                },
                "selected": true,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 190,
                    "y": 2020
                }
            },
            {
                "id": "9fff2d40-4802-46a6-9e9a-7615c47b7754",
                "data": {
                    "name": "Insert_into_omop_measurement",
                    "error": true,
                    "result": "{\n  \"error\": true,\n  \"errorMessage\": \"Traceback (most recent call last):\\n  File \\\"/app/flows/dataflow_ui_plugin/nodes.py\\\", line 468, in task\\n    result = df_to_write.to_sql(self.table_name,\\n            ^^^^^^^^^^^^^^^^^^\\nAttributeError: 'str' object has no attribute 'to_sql'\\n\",\n  \"nodeName\": \"Insert_into_omop_measurement\"\n}",
                    "database": "alpdev_pg",
                    "dataframe": "transform_fhir_omop_measurement",
                    "schemaname": "cdm_ds1_1761010593",
                    "dbtablename": "measurement",
                    "description": "Insert into omop cdm database",
                    "errorMessage": "Traceback (most recent call last):\n  File \"/app/flows/dataflow_ui_plugin/nodes.py\", line 468, in task\n    result = df_to_write.to_sql(self.table_name,\n            ^^^^^^^^^^^^^^^^^^\nAttributeError: 'str' object has no attribute 'to_sql'\n"
                },
                "type": "db_writer_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 750,
                    "y": 2010
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 750,
                    "y": 2010
                }
            },
            {
                "id": "140dffdd-9b98-46a7-ae23-b2b8a6a79a4e",
                "data": {
                    "name": "get_medicationStatement_fhir_data",
                    "error": false,
                    "result": "{\n  \"error\": false,\n  \"errorMessage\": null,\n  \"nodeName\": \"get_medicationStatement_fhir_data\",\n  \"length\": 1,\n  \"type\": \"<class 'pandas.core.frame.DataFrame'>\",\n  \"schema\": {\n    \"content\": \"object\"\n  }\n}",
                    "database": "alp_fhir",
                    "sqlquery": "select content from \"fhir\".\"MedicationStatement\"",
                    "testdata": [
                        []
                    ],
                    "description": "Get fhir data for MedicationStatement resource",
                    "errorMessage": null
                },
                "type": "db_reader_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": -360,
                    "y": 2430
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": -360,
                    "y": 2430
                }
            },
            {
                "id": "a168686a-8581-4f76-a6cf-a60b85187c4c",
                "data": {
                    "id": "MedicationMap",
                    "name": "transform_fhir_omop_drug_exposure",
                    "dataframe": "get_medicationStatement_fhir_data",
                    "description": "Transform condition fhir resource to drug_exposure omop table",
                    "structure_map": {
                        "id": "MedicationMap",
                        "url": "http://hl7.org/fhir/uv/omop/StructureMap/MedicationMap",
                        "date": "2025-07-29T17:40:15+00:00",
                        "name": "MedicationMap",
                        "text": {
                            "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><p class=\"res-header-id\"><b>Generated Narrative: StructureMap MedicationMap</b></p><a name=\"MedicationMap\"> </a><a name=\"hcMedicationMap\"> </a><pre class=\"fml\">\r\n<span style=\"color: #cc00cc\">/// <b>url</b> = </span><span style=\"color: blue\">'http://hl7.org/fhir/uv/omop/StructureMap/MedicationMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>name</b> = </span><span style=\"color: blue\">'MedicationMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>title</b> = </span><span style=\"color: blue\">'Mapping MedicationStatement resource to DrugExposure OMOP Domain'</span>\r\n<span style=\"color: #cc00cc\">/// <b>status</b> = </span><span style=\"color: blue\">'draft'</span>\r\n\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"http://hl7.org/fhir/R5/medicationstatement.html\" title=\"MedicationStatement\">http://hl7.org/fhir/StructureDefinition/MedicationStatement</a><span style=\"color: navy\">&quot; </span><b>alias </b>MedState <b>as </b><b>source</b>\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"StructureDefinition-DrugExposure.html\" title=\"Drug Exposure OMOP Table\">http://hl7.org/fhir/uv/omop/StructureDefinition/DrugExposure</a><span style=\"color: navy\">&quot; </span><b>alias </b>DrugExpTable <b>as </b><b>target</b>\r\n\r\n<b>group </b>MedExposure<span style=\"color: navy\">(</span><b>source</b> <span style=\"color: maroon\">src</span><span style=\"color: navy\"> : </span>MedState, <b>target</b> <span style=\"color: maroon\">tgt</span><span style=\"color: navy\"> : </span>DrugExpTable<span style=\"color: navy\">)</span><span style=\"color: navy\"> {\r\n</span>  src.medication<span style=\"color: navy\"> : </span>CodeableReference<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.concept<b> as </b><span style=\"color: maroon\">scs</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      scs.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>        sc.code<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.drug_concept_id = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n      <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.id as id -&gt; tgt.drug_exposure_id = cast(id, &quot;integer&quot;);</span>\r\n  src.effective<span style=\"color: navy\"> : </span>dateTime<b> as </b><span style=\"color: maroon\">edt</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.drug_exposure_start_datetime = <span style=\"color: maroon\">edt</span><span style=\"color: navy\">, </span> tgt.drug_exposure_start_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">edt</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n  src.effective<span style=\"color: navy\"> : </span>Period<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.start<b> as </b><span style=\"color: maroon\">fps</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.drug_exposure_start_datetime = <span style=\"color: maroon\">fps</span><span style=\"color: navy\">, </span> tgt.drug_exposure_start_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">fps</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  src.effective<span style=\"color: navy\"> : </span>Period<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.end<b> as </b><span style=\"color: maroon\">fpe</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.drug_exposure_end_datetime = <span style=\"color: maroon\">fpe</span><span style=\"color: navy\">, </span> tgt.drug_exposure_end_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">fps</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  src.effective<span style=\"color: navy\"> : </span>Period<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.end<b> as </b><span style=\"color: maroon\">fpe</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.verbatim_end_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">fps</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  src.category<span style=\"color: navy\"> : </span>CodeableConcept<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      sc.code<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.drug_type_concept_id = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  src.reason<span style=\"color: navy\"> : </span>CodeableReference<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.concept<b> as </b><span style=\"color: maroon\">scs</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      scs.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>        sc.code<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.stop_reason = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n      <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n<span style=\"color: navy\">}\r\n\r\n</span></pre></div>",
                            "status": "generated"
                        },
                        "group": [
                            {
                                "name": "MedExposure",
                                "rule": [
                                    {
                                        "name": "medicationCodeableReference",
                                        "rule": [
                                            {
                                                "name": "concept",
                                                "rule": [
                                                    {
                                                        "name": "coding",
                                                        "rule": [
                                                            {
                                                                "name": "code",
                                                                "source": [
                                                                    {
                                                                        "context": "sc",
                                                                        "element": "code",
                                                                        "variable": "a"
                                                                    }
                                                                ],
                                                                "target": [
                                                                    {
                                                                        "context": "tgt",
                                                                        "element": "drug_concept_id",
                                                                        "parameter": [
                                                                            {
                                                                                "valueId": "a"
                                                                            }
                                                                        ],
                                                                        "transform": "copy"
                                                                    }
                                                                ]
                                                            }
                                                        ],
                                                        "source": [
                                                            {
                                                                "context": "scs",
                                                                "element": "coding",
                                                                "variable": "sc"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "tgt"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "concept",
                                                        "variable": "scs"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "type": "CodeableReference",
                                                "context": "src",
                                                "element": "medication",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ],
                                        "documentation": "src.id as id -> tgt.drug_exposure_id = cast(id, \"integer\");"
                                    },
                                    {
                                        "name": "effectiveDateTime",
                                        "source": [
                                            {
                                                "type": "dateTime",
                                                "context": "src",
                                                "element": "effective",
                                                "variable": "edt"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "drug_exposure_start_datetime",
                                                "parameter": [
                                                    {
                                                        "valueId": "edt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            },
                                            {
                                                "context": "tgt",
                                                "element": "drug_exposure_start_date",
                                                "parameter": [
                                                    {
                                                        "valueId": "edt"
                                                    },
                                                    {
                                                        "valueString": "date"
                                                    }
                                                ],
                                                "transform": "cast"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "effectivePeriod",
                                        "rule": [
                                            {
                                                "name": "start",
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "start",
                                                        "variable": "fps"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "drug_exposure_start_datetime",
                                                        "parameter": [
                                                            {
                                                                "valueId": "fps"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    },
                                                    {
                                                        "context": "tgt",
                                                        "element": "drug_exposure_start_date",
                                                        "parameter": [
                                                            {
                                                                "valueId": "fps"
                                                            },
                                                            {
                                                                "valueString": "date"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "type": "Period",
                                                "context": "src",
                                                "element": "effective",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "effectivePeriod",
                                        "rule": [
                                            {
                                                "name": "end",
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "end",
                                                        "variable": "fpe"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "drug_exposure_end_datetime",
                                                        "parameter": [
                                                            {
                                                                "valueId": "fpe"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    },
                                                    {
                                                        "context": "tgt",
                                                        "element": "drug_exposure_end_date",
                                                        "parameter": [
                                                            {
                                                                "valueId": "fps"
                                                            },
                                                            {
                                                                "valueString": "date"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "type": "Period",
                                                "context": "src",
                                                "element": "effective",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "effectivePeriod",
                                        "rule": [
                                            {
                                                "name": "end",
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "end",
                                                        "variable": "fpe"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "verbatim_end_date",
                                                        "parameter": [
                                                            {
                                                                "valueId": "fps"
                                                            },
                                                            {
                                                                "valueString": "date"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "type": "Period",
                                                "context": "src",
                                                "element": "effective",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "categoryCodeableConcept",
                                        "rule": [
                                            {
                                                "name": "coding",
                                                "rule": [
                                                    {
                                                        "name": "code",
                                                        "source": [
                                                            {
                                                                "context": "sc",
                                                                "element": "code",
                                                                "variable": "a"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "drug_type_concept_id",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "a"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "coding",
                                                        "variable": "sc"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "type": "CodeableConcept",
                                                "context": "src",
                                                "element": "category",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "reasonCodeableReference",
                                        "rule": [
                                            {
                                                "name": "concept",
                                                "rule": [
                                                    {
                                                        "name": "coding",
                                                        "rule": [
                                                            {
                                                                "name": "code",
                                                                "source": [
                                                                    {
                                                                        "context": "sc",
                                                                        "element": "code",
                                                                        "variable": "a"
                                                                    }
                                                                ],
                                                                "target": [
                                                                    {
                                                                        "context": "tgt",
                                                                        "element": "stop_reason",
                                                                        "parameter": [
                                                                            {
                                                                                "valueId": "a"
                                                                            }
                                                                        ],
                                                                        "transform": "copy"
                                                                    }
                                                                ]
                                                            }
                                                        ],
                                                        "source": [
                                                            {
                                                                "context": "scs",
                                                                "element": "coding",
                                                                "variable": "sc"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "tgt"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "concept",
                                                        "variable": "scs"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "type": "CodeableReference",
                                                "context": "src",
                                                "element": "reason",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    }
                                ],
                                "input": [
                                    {
                                        "mode": "source",
                                        "name": "src",
                                        "type": "MedState"
                                    },
                                    {
                                        "mode": "target",
                                        "name": "tgt",
                                        "type": "DrugExpTable"
                                    }
                                ]
                            }
                        ],
                        "title": "Mapping MedicationStatement resource to DrugExposure OMOP Domain",
                        "status": "draft",
                        "contact": [
                            {
                                "name": "HL7 International / Biomedical Research and Regulation",
                                "telecom": [
                                    {
                                        "value": "http://www.hl7.org/Special/committees/rcrim",
                                        "system": "url"
                                    }
                                ]
                            }
                        ],
                        "version": "1.0.0-ballot",
                        "extension": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-wg",
                                "valueCode": "brr"
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-fmm",
                                "valueInteger": 1,
                                "_valueInteger": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-standards-status",
                                "valueCode": "informative",
                                "_valueCode": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            }
                        ],
                        "publisher": "HL7 International / Biomedical Research and Regulation",
                        "structure": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/MedicationStatement",
                                "mode": "source",
                                "alias": "MedState"
                            },
                            {
                                "url": "http://hl7.org/fhir/uv/omop/StructureDefinition/DrugExposure",
                                "mode": "target",
                                "alias": "DrugExpTable"
                            }
                        ],
                        "description": "This mapping maps FHIR MedicationStatement instances to OMOP Drug Exposure Table objects.  NOTE: It does not map FHIR MedicationRequest instances although there is a discussion of those instances in the notes.",
                        "jurisdiction": [
                            {
                                "coding": [
                                    {
                                        "code": "001",
                                        "system": "http://unstats.un.org/unsd/methods/m49/m49.htm",
                                        "display": "World"
                                    }
                                ]
                            }
                        ],
                        "resourceType": "StructureMap"
                    },
                    "output_omop_data": ""
                },
                "type": "transform_data_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 170,
                    "y": 2410
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 170,
                    "y": 2410
                }
            },
            {
                "id": "345c3710-002f-4c6d-843b-94e873927548",
                "data": {
                    "name": "Insert_into_omop_drug_exposure",
                    "database": "alpdev_pg",
                    "dataframe": "transform_fhir_omop_drug_exposure",
                    "schemaname": "cdm_ds1_1761010593",
                    "dbtablename": "drug_exposure",
                    "description": "Insert into omop cdm database"
                },
                "type": "db_writer_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 770,
                    "y": 2410
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 770,
                    "y": 2410
                }
            },
            {
                "id": "c1e62222-8885-4467-811f-52e80cf4e3b6",
                "data": {
                    "name": "get_observation_fhir_data",
                    "database": "alp_fhir",
                    "sqlquery": "select content from \"fhir\".\"Observation\"",
                    "testdata": [
                        []
                    ],
                    "description": "Get fhir data for Observation resource"
                },
                "type": "db_reader_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": -340,
                    "y": 2830
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": -340,
                    "y": 2830
                }
            },
            {
                "id": "befd2a41-c7a2-4494-b02b-6817ea042919",
                "data": {
                    "id": "ObservationMap",
                    "name": "transform_fhir_omop_observation",
                    "error": true,
                    "result": "{\n  \"error\": true,\n  \"errorMessage\": \"Traceback (most recent call last):\\n  File \\\"/app/flows/dataflow_ui_plugin/nodes.py\\\", line 441, in task\\n    df = self.transform_data(df_to_write)\\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/flows/dataflow_ui_plugin/nodes.py\\\", line 419, in transform_data\\n    raise Exception(f\\\"FHIR Transform failed with error: {stdout}\\\")\\nException: FHIR Transform failed with error: Transform failed: Error: The 'cast' transform function is not yet supported.\\n{\\\"error\\\":true}\\n\",\n  \"nodeName\": \"transform_fhir_omop_observation\"\n}",
                    "dataframe": "get_observation_fhir_data",
                    "description": "Transform condition fhir resource to observation omop table",
                    "errorMessage": "Traceback (most recent call last):\n  File \"/app/flows/dataflow_ui_plugin/nodes.py\", line 441, in task\n    df = self.transform_data(df_to_write)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/flows/dataflow_ui_plugin/nodes.py\", line 419, in transform_data\n    raise Exception(f\"FHIR Transform failed with error: {stdout}\")\nException: FHIR Transform failed with error: Transform failed: Error: The 'cast' transform function is not yet supported.\n{\"error\":true}\n",
                    "structure_map": {
                        "id": "ObservationMap",
                        "url": "http://hl7.org/fhir/uv/omop/StructureMap/ObservationMap",
                        "date": "2025-07-29T17:40:15+00:00",
                        "name": "ObservationMap",
                        "text": {
                            "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><p class=\"res-header-id\"><b>Generated Narrative: StructureMap ObservationMap</b></p><a name=\"ObservationMap\"> </a><a name=\"hcObservationMap\"> </a><pre class=\"fml\">\r\n<span style=\"color: #cc00cc\">/// <b>url</b> = </span><span style=\"color: blue\">'http://hl7.org/fhir/uv/omop/StructureMap/ObservationMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>name</b> = </span><span style=\"color: blue\">'ObservationMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>title</b> = </span><span style=\"color: blue\">'Mapping Observation resource to  Observation OMOP Domain'</span>\r\n<span style=\"color: #cc00cc\">/// <b>status</b> = </span><span style=\"color: blue\">'draft'</span>\r\n\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"http://hl7.org/fhir/R5/observation.html\" title=\"Observation\">http://hl7.org/fhir/StructureDefinition/Observation</a><span style=\"color: navy\">&quot; </span><b>alias </b>Observation <b>as </b><b>source</b>\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"StructureDefinition-Observation.html\" title=\"Observation OMOP Table\">http://hl7.org/fhir/uv/omop/StructureDefinition/Observation</a><span style=\"color: navy\">&quot; </span><b>alias </b>ObsTable <b>as </b><b>target</b>\r\n\r\n<b>group </b>Observe<span style=\"color: navy\">(</span><b>source</b> <span style=\"color: maroon\">src</span><span style=\"color: navy\"> : </span>Observation, <b>target</b> <span style=\"color: maroon\">tgt</span><span style=\"color: navy\"> : </span>ObsTable<span style=\"color: navy\">)</span><span style=\"color: navy\"> {\r\n</span>  src<b> where </b>('social-history' | 'imaging' | 'survey' | 'exam' | 'therapy' | 'activity' | 'procedure').supersetOf(Observation.category.coding.code)<b> then</b><span style=\"color: navy\"> {\r\n</span>    src.code<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      s.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>        sc.code<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.observation_concept_id = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n      <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.id as id -&gt; tgt.observation_id = cast(id, &quot;integer&quot;);</span>\r\n    src.effective<span style=\"color: navy\"> : </span>dateTime<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.observation_datetime = <span style=\"color: maroon\">a</span><span style=\"color: navy\">, </span> tgt.observation_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">a</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.subject as s -&gt; tgt then {</span>\r\n    src.effective<span style=\"color: navy\"> : </span>instant<b> as </b><span style=\"color: maroon\">einst</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.observation_datetime = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">einst</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'dateTime'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">, </span> tgt.observation_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">einst</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n    src.effective<span style=\"color: navy\"> : </span>Period<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      s.start<b> as </b><span style=\"color: maroon\">ss</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.observation_datetime = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">ss</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'dateTime'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">, </span> tgt.observation_date = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">ss</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'date'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    src.issued<b> as </b><span style=\"color: maroon\">s</span><b> where </b>(s.toDate != src.effectiveDate)<span style=\"color: navy\"><b> -&gt; </b></span>tgt.observation_source_value = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">s</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'string'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">;</span>\r\n    src.value<span style=\"color: navy\"> : </span>Quantity<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      s.value<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.value_as_number = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n      s.unit<b> as </b><span style=\"color: maroon\">b</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.unit_concept_id = <span style=\"color: maroon\">b</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.performer as s -&gt; tgt then {</span>\r\n    src.value<span style=\"color: navy\"> : </span>CodeableConcept<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      s.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>        sc.code<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.value_as_concept_id = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n      <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n    src.value<span style=\"color: navy\"> : </span>string<b> as </b><span style=\"color: maroon\">b</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.value_as_string = <span style=\"color: maroon\">b</span><span style=\"color: navy\">;</span>\r\n    src.note<b> as </b><span style=\"color: maroon\">d</span><span style=\"color: navy\"><b> -&gt; </b></span>tgt.observation_source_value = <span style=\"color: maroon\">d</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span> <i>&quot;OnlyObs&quot;</i><span style=\"color: navy\">;</span>\r\n<span style=\"color: navy\">}\r\n\r\n</span></pre></div>",
                            "status": "generated"
                        },
                        "group": [
                            {
                                "name": "Observe",
                                "rule": [
                                    {
                                        "name": "OnlyObs",
                                        "rule": [
                                            {
                                                "name": "code",
                                                "rule": [
                                                    {
                                                        "name": "coding",
                                                        "rule": [
                                                            {
                                                                "name": "code",
                                                                "source": [
                                                                    {
                                                                        "context": "sc",
                                                                        "element": "code",
                                                                        "variable": "a"
                                                                    }
                                                                ],
                                                                "target": [
                                                                    {
                                                                        "context": "tgt",
                                                                        "element": "observation_concept_id",
                                                                        "parameter": [
                                                                            {
                                                                                "valueId": "a"
                                                                            }
                                                                        ],
                                                                        "transform": "copy"
                                                                    }
                                                                ]
                                                            }
                                                        ],
                                                        "source": [
                                                            {
                                                                "context": "s",
                                                                "element": "coding",
                                                                "variable": "sc"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "tgt"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "src",
                                                        "element": "code",
                                                        "variable": "s"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ],
                                                "documentation": "src.id as id -> tgt.observation_id = cast(id, \"integer\");"
                                            },
                                            {
                                                "name": "effectiveDateTime",
                                                "source": [
                                                    {
                                                        "type": "dateTime",
                                                        "context": "src",
                                                        "element": "effective",
                                                        "variable": "a"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "observation_datetime",
                                                        "parameter": [
                                                            {
                                                                "valueId": "a"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    },
                                                    {
                                                        "context": "tgt",
                                                        "element": "observation_date",
                                                        "parameter": [
                                                            {
                                                                "valueId": "a"
                                                            },
                                                            {
                                                                "valueString": "date"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    }
                                                ],
                                                "documentation": "src.subject as s -> tgt then {"
                                            },
                                            {
                                                "name": "effectiveInstant",
                                                "source": [
                                                    {
                                                        "type": "instant",
                                                        "context": "src",
                                                        "element": "effective",
                                                        "variable": "einst"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "observation_datetime",
                                                        "parameter": [
                                                            {
                                                                "valueId": "einst"
                                                            },
                                                            {
                                                                "valueString": "dateTime"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    },
                                                    {
                                                        "context": "tgt",
                                                        "element": "observation_date",
                                                        "parameter": [
                                                            {
                                                                "valueId": "einst"
                                                            },
                                                            {
                                                                "valueString": "date"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "effectivePeriod",
                                                "rule": [
                                                    {
                                                        "name": "start",
                                                        "source": [
                                                            {
                                                                "context": "s",
                                                                "element": "start",
                                                                "variable": "ss"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "observation_datetime",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "ss"
                                                                    },
                                                                    {
                                                                        "valueString": "dateTime"
                                                                    }
                                                                ],
                                                                "transform": "cast"
                                                            },
                                                            {
                                                                "context": "tgt",
                                                                "element": "observation_date",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "ss"
                                                                    },
                                                                    {
                                                                        "valueString": "date"
                                                                    }
                                                                ],
                                                                "transform": "cast"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "type": "Period",
                                                        "context": "src",
                                                        "element": "effective",
                                                        "variable": "s"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "issued",
                                                "source": [
                                                    {
                                                        "context": "src",
                                                        "element": "issued",
                                                        "variable": "s",
                                                        "condition": "(s.toDate != src.effectiveDate)"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "observation_source_value",
                                                        "parameter": [
                                                            {
                                                                "valueId": "s"
                                                            },
                                                            {
                                                                "valueString": "string"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "valueQuantity",
                                                "rule": [
                                                    {
                                                        "name": "value",
                                                        "source": [
                                                            {
                                                                "context": "s",
                                                                "element": "value",
                                                                "variable": "a"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "value_as_number",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "a"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    },
                                                    {
                                                        "name": "unit",
                                                        "source": [
                                                            {
                                                                "context": "s",
                                                                "element": "unit",
                                                                "variable": "b"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "unit_concept_id",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "b"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "type": "Quantity",
                                                        "context": "src",
                                                        "element": "value",
                                                        "variable": "s"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ],
                                                "documentation": "src.performer as s -> tgt then {"
                                            },
                                            {
                                                "name": "valueCodeableConcept",
                                                "rule": [
                                                    {
                                                        "name": "coding",
                                                        "rule": [
                                                            {
                                                                "name": "code",
                                                                "source": [
                                                                    {
                                                                        "context": "sc",
                                                                        "element": "code",
                                                                        "variable": "a"
                                                                    }
                                                                ],
                                                                "target": [
                                                                    {
                                                                        "context": "tgt",
                                                                        "element": "value_as_concept_id",
                                                                        "parameter": [
                                                                            {
                                                                                "valueId": "a"
                                                                            }
                                                                        ],
                                                                        "transform": "copy"
                                                                    }
                                                                ]
                                                            }
                                                        ],
                                                        "source": [
                                                            {
                                                                "context": "s",
                                                                "element": "coding",
                                                                "variable": "sc"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "tgt"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "type": "CodeableConcept",
                                                        "context": "src",
                                                        "element": "value",
                                                        "variable": "s"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "valueString",
                                                "source": [
                                                    {
                                                        "type": "string",
                                                        "context": "src",
                                                        "element": "value",
                                                        "variable": "b"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "value_as_string",
                                                        "parameter": [
                                                            {
                                                                "valueId": "b"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "note",
                                                "source": [
                                                    {
                                                        "context": "src",
                                                        "element": "note",
                                                        "variable": "d"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "observation_source_value",
                                                        "parameter": [
                                                            {
                                                                "valueId": "d"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "context": "src",
                                                "condition": "('social-history' | 'imaging' | 'survey' | 'exam' | 'therapy' | 'activity' | 'procedure').supersetOf(Observation.category.coding.code)"
                                            }
                                        ]
                                    }
                                ],
                                "input": [
                                    {
                                        "mode": "source",
                                        "name": "src",
                                        "type": "Observation"
                                    },
                                    {
                                        "mode": "target",
                                        "name": "tgt",
                                        "type": "ObsTable"
                                    }
                                ]
                            }
                        ],
                        "title": "Mapping Observation resource to  Observation OMOP Domain",
                        "status": "draft",
                        "contact": [
                            {
                                "name": "HL7 International / Biomedical Research and Regulation",
                                "telecom": [
                                    {
                                        "value": "http://www.hl7.org/Special/committees/rcrim",
                                        "system": "url"
                                    }
                                ]
                            }
                        ],
                        "version": "1.0.0-ballot",
                        "extension": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-wg",
                                "valueCode": "brr"
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-fmm",
                                "valueInteger": 1,
                                "_valueInteger": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-standards-status",
                                "valueCode": "informative",
                                "_valueCode": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            }
                        ],
                        "publisher": "HL7 International / Biomedical Research and Regulation",
                        "structure": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/Observation",
                                "mode": "source",
                                "alias": "Observation"
                            },
                            {
                                "url": "http://hl7.org/fhir/uv/omop/StructureDefinition/Observation",
                                "mode": "target",
                                "alias": "ObsTable"
                            }
                        ],
                        "description": "This mapping maps FHIR Observation instances that are NOT considered measurements to OMOP Observation Table objects.  Currently, this is done by considering the category code and mapping 'social-history', 'imaging', 'survey', 'exam', 'therapy', 'activity', and 'procedure' Observations.",
                        "jurisdiction": [
                            {
                                "coding": [
                                    {
                                        "code": "001",
                                        "system": "http://unstats.un.org/unsd/methods/m49/m49.htm",
                                        "display": "World"
                                    }
                                ]
                            }
                        ],
                        "resourceType": "StructureMap"
                    },
                    "output_omop_data": ""
                },
                "type": "transform_data_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 200,
                    "y": 2820
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 200,
                    "y": 2820
                }
            },
            {
                "id": "a51a4106-095e-49a8-a868-db5874ed60f5",
                "data": {
                    "name": "Insert_into_omop_observation",
                    "error": true,
                    "result": "{\n  \"error\": true,\n  \"errorMessage\": \"Traceback (most recent call last):\\n  File \\\"/app/flows/dataflow_ui_plugin/nodes.py\\\", line 468, in task\\n    result = df_to_write.to_sql(self.table_name,\\n            ^^^^^^^^^^^^^^^^^^\\nAttributeError: 'str' object has no attribute 'to_sql'\\n\",\n  \"nodeName\": \"Insert_into_omop_observation\"\n}",
                    "database": "alpdev_pg",
                    "dataframe": "transform_fhir_omop_observation",
                    "schemaname": "cdm_ds1_1761010593",
                    "dbtablename": "observation",
                    "description": "Insert into omop cdm database",
                    "errorMessage": "Traceback (most recent call last):\n  File \"/app/flows/dataflow_ui_plugin/nodes.py\", line 468, in task\n    result = df_to_write.to_sql(self.table_name,\n            ^^^^^^^^^^^^^^^^^^\nAttributeError: 'str' object has no attribute 'to_sql'\n"
                },
                "type": "db_writer_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 780,
                    "y": 2820
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 780,
                    "y": 2820
                }
            },
            {
                "id": "230782cf-935e-4354-9c89-db8a2f37bf99",
                "data": {
                    "name": "get_procedure_fhir_data",
                    "error": false,
                    "result": "{\n  \"error\": false,\n  \"errorMessage\": null,\n  \"nodeName\": \"get_procedure_fhir_data\",\n  \"length\": 1,\n  \"type\": \"<class 'pandas.core.frame.DataFrame'>\",\n  \"schema\": {\n    \"content\": \"object\"\n  }\n}",
                    "database": "alp_fhir",
                    "sqlquery": "select content from \"fhir\".\"Procedure\"",
                    "testdata": [
                        []
                    ],
                    "description": "Get fhir data for Procedure resource",
                    "errorMessage": null
                },
                "type": "db_reader_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": -350,
                    "y": 3170
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": -350,
                    "y": 3170
                }
            },
            {
                "id": "e0691f92-eb19-4657-a9da-c0eae7974288",
                "data": {
                    "id": "ProcedureMap",
                    "name": "transform_fhir_omop_procedure_occurrence",
                    "error": false,
                    "result": "{\n  \"error\": false,\n  \"errorMessage\": null,\n  \"nodeName\": \"transform_fhir_omop_procedure_occurrence\",\n  \"length\": 1,\n  \"type\": \"<class 'pandas.core.frame.DataFrame'>\",\n  \"schema\": {\n    \"procedure_source_value\": \"object\",\n    \"procedure_source_concept_id\": \"object\"\n  }\n}",
                    "dataframe": "get_procedure_fhir_data",
                    "description": "Transform condition fhir resource to procedure_occurrence omop table",
                    "errorMessage": null,
                    "structure_map": {
                        "id": "ProcedureMap",
                        "url": "http://hl7.org/fhir/uv/omop/StructureMap/ProcedureMap",
                        "date": "2025-07-29T17:40:15+00:00",
                        "name": "ProcedureMap",
                        "text": {
                            "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><p class=\"res-header-id\"><b>Generated Narrative: StructureMap ProcedureMap</b></p><a name=\"ProcedureMap\"> </a><a name=\"hcProcedureMap\"> </a><pre class=\"fml\">\r\n<span style=\"color: #cc00cc\">/// <b>url</b> = </span><span style=\"color: blue\">'http://hl7.org/fhir/uv/omop/StructureMap/ProcedureMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>name</b> = </span><span style=\"color: blue\">'ProcedureMap'</span>\r\n<span style=\"color: #cc00cc\">/// <b>title</b> = </span><span style=\"color: blue\">'Mapping Procedure resource to Procedure Occurrence OMOP Domain'</span>\r\n<span style=\"color: #cc00cc\">/// <b>status</b> = </span><span style=\"color: blue\">'draft'</span>\r\n\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"http://hl7.org/fhir/R5/procedure.html\" title=\"Procedure\">http://hl7.org/fhir/StructureDefinition/Procedure</a><span style=\"color: navy\">&quot; </span><b>alias </b>Procedure <b>as </b><b>source</b>\r\n<b>uses</b><span style=\"color: navy\"> &quot;</span><a href=\"StructureDefinition-ProcedureOccurrence.html\" title=\"Procedure Occurrence OMOP Table\">http://hl7.org/fhir/uv/omop/StructureDefinition/ProcedureOccurrence</a><span style=\"color: navy\">&quot; </span><b>alias </b>ProcedureTable <b>as </b><b>target</b>\r\n\r\n<b>group </b>ProcedureOccurrence<span style=\"color: navy\">(</span><b>source</b> <span style=\"color: maroon\">src</span><span style=\"color: navy\"> : </span>Procedure, <b>target</b> <span style=\"color: maroon\">tgt</span><span style=\"color: navy\"> : </span>ProcedureTable<span style=\"color: navy\">)</span><span style=\"color: navy\"> {\r\n</span>  src.code<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.coding<b> as </b><span style=\"color: maroon\">sc</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>      sc.code<b> as </b><span style=\"color: maroon\">a</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.procedure_concept_id<span style=\"color: navy\">, </span> tgt.procedure_source_value<span style=\"color: navy\">, </span> tgt.procedure_source_concept_id = <span style=\"color: maroon\">a</span><span style=\"color: navy\">;</span>\r\n    <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span> <span style=\"color: navy\">// </span><span style=\"color: green\">src.id as id -&gt; tgt.procedure_occurrence_id = cast(id, &quot;integer&quot;);</span>\r\n  src.occurrence<span style=\"color: navy\"> : </span>dateTime<b> as </b><span style=\"color: maroon\">edt</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.procedure_datetime = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">edt</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'dateTime'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">, </span> tgt.procedure_date = <span style=\"color: maroon\">edt</span><span style=\"color: navy\">;</span>\r\n  src.occurrence<span style=\"color: navy\"> : </span>Period<b> as </b><span style=\"color: maroon\">s</span><span style=\"color: navy\"><b> -&gt; </b></span><span style=\"color: maroon\">tgt</span><b> then</b><span style=\"color: navy\"> {\r\n</span>    s.start<b> as </b><span style=\"color: maroon\">start</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.procedure_datetime = <b>cast</b><span style=\"color: navy\">(</span><span style=\"color: maroon\">start</span><span style=\"color: navy\">, </span><span style=\"color: blue\">'dateTime'</span><span style=\"color: navy\">)</span><span style=\"color: navy\">, </span> tgt.procedure_date = <span style=\"color: maroon\">start</span><span style=\"color: navy\">;</span>\r\n    s.end<b> as </b><span style=\"color: maroon\">end</span><span style=\"color: navy\"><b> -&gt; </b></span> tgt.procedure_end_datetime<span style=\"color: navy\">, </span> tgt.procedure_end_date = <span style=\"color: maroon\">end</span><span style=\"color: navy\">;</span>\r\n  <span style=\"color: navy\">}</span><span style=\"color: navy\">;</span>\r\n<span style=\"color: navy\">}\r\n\r\n</span></pre></div>",
                            "status": "generated"
                        },
                        "group": [
                            {
                                "name": "ProcedureOccurrence",
                                "rule": [
                                    {
                                        "name": "code",
                                        "rule": [
                                            {
                                                "name": "coding",
                                                "rule": [
                                                    {
                                                        "name": "code",
                                                        "source": [
                                                            {
                                                                "context": "sc",
                                                                "element": "code",
                                                                "variable": "a"
                                                            }
                                                        ],
                                                        "target": [
                                                            {
                                                                "context": "tgt",
                                                                "element": "procedure_concept_id"
                                                            },
                                                            {
                                                                "context": "tgt",
                                                                "element": "procedure_source_value"
                                                            },
                                                            {
                                                                "context": "tgt",
                                                                "element": "procedure_source_concept_id",
                                                                "parameter": [
                                                                    {
                                                                        "valueId": "a"
                                                                    }
                                                                ],
                                                                "transform": "copy"
                                                            }
                                                        ]
                                                    }
                                                ],
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "coding",
                                                        "variable": "sc"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "parameter": [
                                                            {
                                                                "valueId": "tgt"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "context": "src",
                                                "element": "code",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ],
                                        "documentation": "src.id as id -> tgt.procedure_occurrence_id = cast(id, \"integer\");"
                                    },
                                    {
                                        "name": "occurrenceDateTime",
                                        "source": [
                                            {
                                                "type": "dateTime",
                                                "context": "src",
                                                "element": "occurrence",
                                                "variable": "edt"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "context": "tgt",
                                                "element": "procedure_datetime",
                                                "parameter": [
                                                    {
                                                        "valueId": "edt"
                                                    },
                                                    {
                                                        "valueString": "dateTime"
                                                    }
                                                ],
                                                "transform": "cast"
                                            },
                                            {
                                                "context": "tgt",
                                                "element": "procedure_date",
                                                "parameter": [
                                                    {
                                                        "valueId": "edt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    },
                                    {
                                        "name": "occurrencePeriod",
                                        "rule": [
                                            {
                                                "name": "start",
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "start",
                                                        "variable": "start"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "procedure_datetime",
                                                        "parameter": [
                                                            {
                                                                "valueId": "start"
                                                            },
                                                            {
                                                                "valueString": "dateTime"
                                                            }
                                                        ],
                                                        "transform": "cast"
                                                    },
                                                    {
                                                        "context": "tgt",
                                                        "element": "procedure_date",
                                                        "parameter": [
                                                            {
                                                                "valueId": "start"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "end",
                                                "source": [
                                                    {
                                                        "context": "s",
                                                        "element": "end",
                                                        "variable": "end"
                                                    }
                                                ],
                                                "target": [
                                                    {
                                                        "context": "tgt",
                                                        "element": "procedure_end_datetime"
                                                    },
                                                    {
                                                        "context": "tgt",
                                                        "element": "procedure_end_date",
                                                        "parameter": [
                                                            {
                                                                "valueId": "end"
                                                            }
                                                        ],
                                                        "transform": "copy"
                                                    }
                                                ]
                                            }
                                        ],
                                        "source": [
                                            {
                                                "type": "Period",
                                                "context": "src",
                                                "element": "occurrence",
                                                "variable": "s"
                                            }
                                        ],
                                        "target": [
                                            {
                                                "parameter": [
                                                    {
                                                        "valueId": "tgt"
                                                    }
                                                ],
                                                "transform": "copy"
                                            }
                                        ]
                                    }
                                ],
                                "input": [
                                    {
                                        "mode": "source",
                                        "name": "src",
                                        "type": "Procedure"
                                    },
                                    {
                                        "mode": "target",
                                        "name": "tgt",
                                        "type": "ProcedureTable"
                                    }
                                ]
                            }
                        ],
                        "title": "Mapping Procedure resource to Procedure Occurrence OMOP Domain",
                        "status": "draft",
                        "contact": [
                            {
                                "name": "HL7 International / Biomedical Research and Regulation",
                                "telecom": [
                                    {
                                        "value": "http://www.hl7.org/Special/committees/rcrim",
                                        "system": "url"
                                    }
                                ]
                            }
                        ],
                        "version": "1.0.0-ballot",
                        "extension": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-wg",
                                "valueCode": "brr"
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-fmm",
                                "valueInteger": 1,
                                "_valueInteger": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            },
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-standards-status",
                                "valueCode": "informative",
                                "_valueCode": {
                                    "extension": [
                                        {
                                            "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom",
                                            "valueCanonical": "http://hl7.org/fhir/uv/omop/ImplementationGuide/hl7.fhir.uv.omop"
                                        }
                                    ]
                                }
                            }
                        ],
                        "publisher": "HL7 International / Biomedical Research and Regulation",
                        "structure": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/Procedure",
                                "mode": "source",
                                "alias": "Procedure"
                            },
                            {
                                "url": "http://hl7.org/fhir/uv/omop/StructureDefinition/ProcedureOccurrence",
                                "mode": "target",
                                "alias": "ProcedureTable"
                            }
                        ],
                        "description": "This mapping maps FHIR Procedure instances to OMOP Procedure Occurrence Table objects.",
                        "jurisdiction": [
                            {
                                "coding": [
                                    {
                                        "code": "001",
                                        "system": "http://unstats.un.org/unsd/methods/m49/m49.htm",
                                        "display": "World"
                                    }
                                ]
                            }
                        ],
                        "resourceType": "StructureMap"
                    },
                    "output_omop_data": ""
                },
                "type": "transform_data_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 190,
                    "y": 3160
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 190,
                    "y": 3160
                }
            },
            {
                "id": "cf76f9a9-321b-469f-8779-fc8945fd50f6",
                "data": {
                    "name": "Insert_into_omop_procedure_occurrence",
                    "error": true,
                    "result": "{\n  \"error\": true,\n  \"errorMessage\": \"Traceback (most recent call last):\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\\\", line 1964, in _exec_single_context\\n    self.dialect.do_execute(\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py\\\", line 942, in do_execute\\n    cursor.execute(statement, parameters)\\npsycopg2.errors.NotNullViolation: null value in column \\\"procedure_occurrence_id\\\" of relation \\\"procedure_occurrence\\\" violates not-null constraint\\nDETAIL:  Failing row contains (null, null, null, null, null, null, null, null, null, null, null, null, null, {80146002,80146002}, 80146002, null).\\n\\n\\nThe above exception was the direct cause of the following exception:\\n\\nTraceback (most recent call last):\\n  File \\\"/app/flows/dataflow_ui_plugin/nodes.py\\\", line 468, in task\\n    result = df_to_write.to_sql(self.table_name,\\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/util/_decorators.py\\\", line 333, in wrapper\\n    return func(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/core/generic.py\\\", line 3087, in to_sql\\n    return sql.to_sql(\\n           ^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\\\", line 842, in to_sql\\n    return pandas_sql.to_sql(\\n           ^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\\\", line 2018, in to_sql\\n    total_inserted = sql_engine.insert_records(\\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\\\", line 1567, in insert_records\\n    raise err\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\\\", line 1558, in insert_records\\n    return table.insert(chunksize=chunksize, method=method)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\\\", line 1119, in insert\\n    num_inserted = exec_insert(conn, keys, chunk_iter)\\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\\\", line 1010, in _execute_insert\\n    result = conn.execute(self.table.insert(), data)\\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\\\", line 1416, in execute\\n    return meth(\\n           ^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py\\\", line 516, in _execute_on_connection\\n    return connection._execute_clauseelement(\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\\\", line 1638, in _execute_clauseelement\\n    ret = self._execute_context(\\n          ^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\\\", line 1843, in _execute_context\\n    return self._exec_single_context(\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\\\", line 1983, in _exec_single_context\\n    self._handle_dbapi_exception(\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\\\", line 2352, in _handle_dbapi_exception\\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\\\", line 1964, in _exec_single_context\\n    self.dialect.do_execute(\\n  File \\\"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py\\\", line 942, in do_execute\\n    cursor.execute(statement, parameters)\\nsqlalchemy.exc.IntegrityError: (psycopg2.errors.NotNullViolation) null value in column \\\"procedure_occurrence_id\\\" of relation \\\"procedure_occurrence\\\" violates not-null constraint\\nDETAIL:  Failing row contains (null, null, null, null, null, null, null, null, null, null, null, null, null, {80146002,80146002}, 80146002, null).\\n\\n[SQL: INSERT INTO cdm_ds1_1761010593.procedure_occurrence (procedure_source_value, procedure_source_concept_id) VALUES (%(procedure_source_value)s, %(procedure_source_concept_id)s)]\\n[parameters: {'procedure_source_value': ['80146002', '80146002'], 'procedure_source_concept_id': '80146002'}]\\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\\n\",\n  \"nodeName\": \"Insert_into_omop_procedure_occurrence\"\n}",
                    "database": "alpdev_pg",
                    "dataframe": "transform_fhir_omop_procedure_occurrence",
                    "schemaname": "cdm_ds1_1761010593",
                    "dbtablename": "procedure_occurrence",
                    "description": "Insert into omop cdm database",
                    "errorMessage": "Traceback (most recent call last):\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1964, in _exec_single_context\n    self.dialect.do_execute(\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py\", line 942, in do_execute\n    cursor.execute(statement, parameters)\npsycopg2.errors.NotNullViolation: null value in column \"procedure_occurrence_id\" of relation \"procedure_occurrence\" violates not-null constraint\nDETAIL:  Failing row contains (null, null, null, null, null, null, null, null, null, null, null, null, null, {80146002,80146002}, 80146002, null).\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/app/flows/dataflow_ui_plugin/nodes.py\", line 468, in task\n    result = df_to_write.to_sql(self.table_name,\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/util/_decorators.py\", line 333, in wrapper\n    return func(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/core/generic.py\", line 3087, in to_sql\n    return sql.to_sql(\n           ^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\", line 842, in to_sql\n    return pandas_sql.to_sql(\n           ^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\", line 2018, in to_sql\n    total_inserted = sql_engine.insert_records(\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\", line 1567, in insert_records\n    raise err\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\", line 1558, in insert_records\n    return table.insert(chunksize=chunksize, method=method)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\", line 1119, in insert\n    num_inserted = exec_insert(conn, keys, chunk_iter)\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/pandas/io/sql.py\", line 1010, in _execute_insert\n    result = conn.execute(self.table.insert(), data)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1416, in execute\n    return meth(\n           ^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py\", line 516, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1638, in _execute_clauseelement\n    ret = self._execute_context(\n          ^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1843, in _execute_context\n    return self._exec_single_context(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1983, in _exec_single_context\n    self._handle_dbapi_exception(\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 2352, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1964, in _exec_single_context\n    self.dialect.do_execute(\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py\", line 942, in do_execute\n    cursor.execute(statement, parameters)\nsqlalchemy.exc.IntegrityError: (psycopg2.errors.NotNullViolation) null value in column \"procedure_occurrence_id\" of relation \"procedure_occurrence\" violates not-null constraint\nDETAIL:  Failing row contains (null, null, null, null, null, null, null, null, null, null, null, null, null, {80146002,80146002}, 80146002, null).\n\n[SQL: INSERT INTO cdm_ds1_1761010593.procedure_occurrence (procedure_source_value, procedure_source_concept_id) VALUES (%(procedure_source_value)s, %(procedure_source_concept_id)s)]\n[parameters: {'procedure_source_value': ['80146002', '80146002'], 'procedure_source_concept_id': '80146002'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\n"
                },
                "type": "db_writer_node",
                "width": 350,
                "height": 210,
                "dragging": false,
                "position": {
                    "x": 760,
                    "y": 3160
                },
                "selected": false,
                "dragHandle": "",
                "sourcePosition": "right",
                "targetPosition": "left",
                "positionAbsolute": {
                    "x": 760,
                    "y": 3160
                }
            }
        ],
        "variables": [],
        "importLibs": []
    }
}